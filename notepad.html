<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Static Web Notepad</title>
  <!-- Libraries (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/html-docx-js@0.4.1/dist/html-docx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.3/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>

  <style>
    :root{--bg:#f7f8fb;--card:#fff;--muted:#666}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:#111}
    .app{display:grid;grid-template-columns:300px 1fr;grid-template-rows:1fr auto;height:100vh}
    nav{background:var(--card);border-right:1px solid #e6e9ef;padding:12px;overflow:auto}
    header{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    header h2{margin:0;font-size:16px}
    .controls{display:flex;gap:6px;flex-wrap:wrap}
    button,select,input[type=text]{background:#fff;border:1px solid #ddd;padding:6px 8px;border-radius:6px;cursor:pointer}
    button.small{padding:6px}
    .list{margin-top:8px}
    .section-title{font-size:12px;color:var(--muted);margin:10px 0 6px}

    /* file / folder list */
    .folder, .file-item{padding:8px;border-radius:6px;margin-bottom:6px;display:flex;align-items:center;justify-content:space-between}
    .folder{background:linear-gradient(90deg,#fdfdfd,#fbfcff);border:1px solid #eee}
    .file-item{background:#fff;border:1px solid #f0f3f7}
    .file-item .meta{flex:1;overflow:hidden}
    .file-item .meta .name{font-weight:600;white-space:nowrap;text-overflow:ellipsis;overflow:hidden}
    .file-item .meta .sub{font-size:12px;color:var(--muted)}
    .file-item .actions{display:flex;gap:6px;margin-left:8px}

    /* editor area */
    main{display:flex;flex-direction:column;gap:8px;padding:12px}
    .toolbar{display:flex;gap:6px;align-items:center}
    .toolbar .group{display:flex;gap:6px;align-items:center;background:var(--card);padding:6px;border-radius:8px;border:1px solid #e9edf3}
    #editor{flex:1;background:var(--card);border:1px solid #e6e9ef;padding:16px;border-radius:8px;overflow:auto}
    #editor[contenteditable="true"]:focus{outline:3px solid rgba(100,150,250,0.12)}

    footer{grid-column:1 / -1;background:transparent;padding:8px 12px;border-top:1px solid #e9edf3;display:flex;justify-content:space-between;align-items:center}
    a.github{font-weight:600;text-decoration:none;color:#0b66ff}

    /* small responsive */
    @media (max-width:800px){.app{grid-template-columns:1fr;grid-template-rows:auto 1fr auto}nav{order:2;height:220px;overflow:auto}.editor-wrap{order:1}}
  </style>
</head>
<body>
  <div class="app">
    <nav>
      <header>
        <h2>Web Notepad</h2>
        <div style="margin-left:auto;display:flex;gap:6px;align-items:center">
          <button class="small" id="btnNewFile">+ 파일</button>
          <button class="small" id="btnNewFolder">+ 폴더</button>
        </div>
      </header>

      <div class="controls">
        <input id="search" type="text" placeholder="검색 (파일명/내용)" style="flex:1">
        <select id="filter"><option value="all">전체</option><option value="star">북마크</option></select>
      </div>

      <div class="list">
        <div class="section-title">폴더</div>
        <div id="folders"></div>

        <div class="section-title">파일</div>
        <div id="files"></div>
      </div>

      <div style="margin-top:12px">
        <div class="section-title">임포트</div>
        <input id="fileInput" type="file" multiple accept=".txt,.md,.html,.docx,.pdf" />
        <div style="margin-top:6px;font-size:12px;color:var(--muted)">여러 파일 선택 가능 • .txt/.docx/.pdf 지원</div>

        <div class="section-title" style="margin-top:12px">병합 / 관리</div>
        <button id="btnMerge">선택 파일 병합</button>
        <button id="btnDeleteSelected">선택 삭제</button>
      </div>
    </nav>

    <main class="editor-wrap">
      <div class="toolbar">
        <div class="group">
          <button onclick="doCmd('bold')"><b>B</b></button>
          <button onclick="doCmd('italic')"><i>I</i></button>
          <button onclick="doCmd('underline')"><u>U</u></button>
          <button onclick="doCmd('strikeThrough')">S</button>
          <input type="color" id="colorPick" title="색상" onchange="doCmd('foreColor', this.value)">
          <select id="fontSize" onchange="doCmd('fontSize', this.value)"><option value="3">기본</option><option value="4">크게</option><option value="5">더 크게</option></select>
        </div>

        <div class="group">
          <button id="btnSave">저장</button>
          <button id="btnExportTxt">.txt 저장</button>
          <button id="btnExportDocx">.docx 저장</button>
          <button id="btnExportPdf">.pdf 저장</button>
          <label style="display:inline-flex;align-items:center;gap:6px;font-size:13px"><input type="checkbox" id="autoSave"> 자동저장</label>
        </div>

        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <button id="btnStar">⭐</button>
          <button id="btnMove">이동</button>
          <select id="moveToFolder" style="display:none"></select>
          <button id="btnMergeUI">병합 UI</button>
          <button id="btnToggleDark">다크모드</button>
        </div>
      </div>

      <div id="editor" contenteditable="true" spellcheck="false"></div>

    </main>

    <footer>
      <div>제작자 :  <a class="github" href="https://github.com/2000may24th" target="_blank">https://github.com/2000may24th</a></div>
      <div style="font-size:12px;color:var(--muted)">로컬 저장 • 정적 페이지 (Github Pages)에서 동작</div>
    </footer>
  </div>

<script>
// --- 데이터 model (localStorage 기반) ---
const DB_KEY = 'web_notepad_v1';
let db = {folders: {}, files: {}, order: []};
let selectedFiles = new Set();
let currentFileId = null;

function loadDB(){
  const raw = localStorage.getItem(DB_KEY);
  if(raw) try{db = JSON.parse(raw)}catch(e){console.error(e)}
}
function saveDB(){
  localStorage.setItem(DB_KEY, JSON.stringify(db));
}

function uid(prefix='f'){return prefix+Date.now().toString(36)+Math.random().toString(36).slice(2,8)}

// --- initial ---
loadDB();
if(Object.keys(db.files).length===0){
  const id = uid(); db.files[id] = {id,name:'새 문서',content:'',folder:null,star:false,created:Date.now(),updated:Date.now()}; db.order.push(id); saveDB();}

// --- render ---
function render(){
  renderFolders();
  renderFiles();
  renderMoveList();
}

function renderFolders(){
  const cont = document.getElementById('folders'); cont.innerHTML='';
  Object.values(db.folders).forEach(f=>{
    const el = document.createElement('div'); el.className='folder';
    el.innerHTML = `<div style="flex:1">📁 ${escapeHtml(f.name)}</div><div style="display:flex;gap:6px"><button onclick="renameFolder('${f.id}')">✏️</button><button onclick="deleteFolder('${f.id}')">🗑️</button></div>`;
    cont.appendChild(el);
  })
}

function renderFiles(){
  const cont = document.getElementById('files'); cont.innerHTML='';
  const q = document.getElementById('search').value.toLowerCase();
  const filter = document.getElementById('filter').value;
  db.order.forEach(id=>{
    const f = db.files[id];
    if(!f) return;
    if(filter==='star' && !f.star) return;
    if(q){if(!(f.name.toLowerCase().includes(q) || stripTags(f.content).toLowerCase().includes(q))) return}
    const div = document.createElement('div'); div.className='file-item';
    div.innerHTML = `<div class="meta"><div class="name">${escapeHtml(f.name)}</div><div class="sub">${f.folder?db.folders[f.folder]?.name+' • ':''}${new Date(f.updated).toLocaleString()}</div></div>
      <div class="actions">
        <input type="checkbox" onchange="toggleSelect(event,'${f.id}')" ${selectedFiles.has(f.id)?'checked':''}>
        <button onclick="openFile('${f.id}')">열기</button>
        <button onclick="downloadTxt('${f.id}')">다운</button>
        <button onclick="toggleStar('${f.id}')">${f.star?'★':'☆'}</button>
        <button onclick="deleteFile('${f.id}')">🗑️</button>
      </div>`;
    cont.appendChild(div);
  })
}

function renderMoveList(){
  const sel = document.getElementById('moveToFolder'); sel.innerHTML='';
  const opt = document.createElement('option'); opt.value='__null'; opt.textContent='루트'; sel.appendChild(opt);
  Object.values(db.folders).forEach(f=>{const o=document.createElement('option');o.value=f.id;o.textContent=f.name;sel.appendChild(o)})
}

// --- helpers ---
function escapeHtml(s){return (s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c])}
function stripTags(html){return html.replace(/<[^>]+>/g,'')}

// --- file ops ---
function newFile(){
  const id=uid(); db.files[id]={id,name:'무제',content:'',folder:null,star:false,created:Date.now(),updated:Date.now()}; db.order.unshift(id); saveDB(); render(); openFile(id);
}
function newFolder(){
  const name = prompt('폴더 이름:'); if(!name) return; const id=uid('d'); db.folders[id]={id,name}; saveDB(); render();
}

function renameFolder(id){
  const name = prompt('새 폴더 이름:', db.folders[id].name); if(!name) return; db.folders[id].name=name; saveDB(); render();
}
function deleteFolder(id){
  if(!confirm('폴더와 그 안의 파일들을 삭제하시겠어요?')) return;
  Object.values(db.files).forEach(f=>{if(f.folder===id) delete db.files[f.id];}); delete db.folders[id]; db.order = db.order.filter(x=>db.files[x]); saveDB(); render();
}

function openFile(id){
  currentFileId = id; const f = db.files[id]; document.getElementById('editor').innerHTML = f.content || '';
  // update title highlight
}

function saveCurrent(){
  if(!currentFileId) return alert('먼저 파일을 선택하세요');
  const content = document.getElementById('editor').innerHTML;
  const f = db.files[currentFileId]; f.content = content; f.updated = Date.now(); if(!f.name || f.name==='무제'){
    const t = stripTags(content).slice(0,30).trim(); if(t) f.name = t;
  }
  saveDB(); render();
}

function deleteFile(id){
  if(!confirm('파일을 삭제할까요?')) return; delete db.files[id]; db.order = db.order.filter(x=>x!==id); saveDB(); render();
}

function toggleSelect(ev,id){ if(ev.target.checked) selectedFiles.add(id); else selectedFiles.delete(id); }

function toggleStar(id){ db.files[id].star = !db.files[id].star; saveDB(); render(); }

function downloadTxt(id){ const f=db.files[id]; const blob=new Blob([stripTags(f.content)],{type:'text/plain;charset=utf-8'}); saveAs(blob, (f.name||'untitled')+'.txt'); }

// --- import ---
const fileInput = document.getElementById('fileInput'); fileInput.addEventListener('change', async e=>{
  const filesList = Array.from(e.target.files);
  for(const file of filesList){
    const name = prompt(`불러올 파일의 이름 (파일: ${file.name})`, file.name.replace(/\.[^.]+$/,''));
    if(!name) continue;
    try{
      if(file.name.endsWith('.txt')||file.type.includes('text')){
        const txt = await file.text(); const id=uid(); db.files[id]={id,name,content:escapeHtml(txt).replace(/\n/g,'<br>'),folder:null,star:false,created:Date.now(),updated:Date.now()}; db.order.unshift(id);
      } else if(file.name.endsWith('.docx')){
        // docx read in-browser is complex; fallback: offer to upload as blob and create placeholder
        const arr = await file.arrayBuffer(); const id=uid(); db.files[id]={id,name,content:`(DOCX 파일 — 원본을 다운로드하려면 첨부됨)`,raw:{type:'docx',data:arrayBufferToBase64(arr)},folder:null,star:false,created:Date.now(),updated:Date.now()}; db.order.unshift(id);
      } else if(file.name.endsWith('.pdf')){
        const arr = await file.arrayBuffer(); const id=uid(); db.files[id]={id,name,content:`(PDF 파일 — 미리보기 없음)`,raw:{type:'pdf',data:arrayBufferToBase64(arr)},folder:null,star:false,created:Date.now(),updated:Date.now()}; db.order.unshift(id);
      } else {
        const txt = await file.text(); const id=uid(); db.files[id]={id,name,content:escapeHtml(txt).replace(/\n/g,'<br>'),folder:null,star:false,created:Date.now(),updated:Date.now()}; db.order.unshift(id);
      }
    } catch(err){console.error(err)}
  }
  saveDB(); render(); fileInput.value='';
});

function arrayBufferToBase64(buffer){ let binary=''; const bytes = new Uint8Array(buffer); const len = bytes.byteLength; for(let i=0;i<len;i++){binary+=String.fromCharCode(bytes[i]);} return btoa(binary); }

// --- merge selected ---
function mergeSelected(){ if(selectedFiles.size<2) return alert('두 개 이상의 파일을 선택하세요');
  const ids = Array.from(selectedFiles); let merged=''; let name='병합문서'; ids.forEach(id=>{const f=db.files[id]; merged += `<h3>${escapeHtml(f.name)}</h3>` + (f.content||'') + '<hr>';});
  const id = uid(); db.files[id]={id,name: name,content:merged,folder:null,star:false,created:Date.now(),updated:Date.now()}; db.order.unshift(id); saveDB(); render(); openFile(id); selectedFiles.clear();
}

// --- delete selected ---
function deleteSelected(){ if(selectedFiles.size===0) return alert('선택된 파일이 없습니다'); if(!confirm('선택된 파일을 삭제할까요?')) return; selectedFiles.forEach(id=>{delete db.files[id]; db.order = db.order.filter(x=>x!==id)}); saveDB(); render(); selectedFiles.clear(); }

// --- move ---
function moveSelected(){ if(selectedFiles.size===0) return alert('선택된 파일이 없습니다'); const to = document.getElementById('moveToFolder').value; selectedFiles.forEach(id=>{db.files[id].folder = (to==='__null'?null:to); db.files[id].updated = Date.now()}); saveDB(); render(); selectedFiles.clear(); }

// --- export docx/pdf/txt global (current file) ---
async function exportDocx(id){ const f = db.files[id]; const html = `<html><body>${f.content||''}</body></html>`; try{
  const converted = window.htmlDocx.asBlob(html);
  saveAs(converted, (f.name||'document') + '.docx');
}catch(e){alert('DOCX 생성 실패: '+e.message)} }

async function exportPdf(id){ const f=db.files[id]; const { jsPDF } = window.jspdf; const doc = new jsPDF(); const text = stripTags(f.content); const lines = doc.splitTextToSize(text, 180); doc.text(lines,10,10); const blob = doc.output('blob'); saveAs(blob, (f.name||'doc') + '.pdf'); }

// --- UI bindings ---
document.getElementById('btnNewFile').onclick = newFile;
document.getElementById('btnNewFolder').onclick = newFolder;
document.getElementById('search').addEventListener('input', render);
document.getElementById('filter').addEventListener('change', render);
document.getElementById('btnSave').onclick = ()=>{saveCurrent(); alert('저장됨')};
document.getElementById('btnExportTxt').onclick = ()=>{ if(!currentFileId) return alert('파일 선택'); downloadTxt(currentFileId)};
document.getElementById('btnExportDocx').onclick = ()=>{ if(!currentFileId) return alert('파일 선택'); exportDocx(currentFileId)};
document.getElementById('btnExportPdf').onclick = ()=>{ if(!currentFileId) return alert('파일 선택'); exportPdf(currentFileId)};
document.getElementById('btnMerge').onclick = mergeSelected;
document.getElementById('btnDeleteSelected').onclick = deleteSelected;

// move
const btnMove = document.getElementById('btnMove'); const selMove = document.getElementById('moveToFolder');
btnMove.onclick = ()=>{ if(selMove.style.display==='none'){selMove.style.display='inline-block'; btnMove.textContent='이동(확인)';} else {moveSelected(); selMove.style.display='none'; btnMove.textContent='이동';}}

// star
document.getElementById('btnStar').onclick = ()=>{ if(!currentFileId) return alert('파일 선택'); toggleStar(currentFileId)};

// merge UI quick
let mergeMode=false; document.getElementById('btnMergeUI').onclick = ()=>{mergeMode=!mergeMode; alert('병합 UI ' + (mergeMode?'활성화':'비활성화') + '. 좌측에서 파일을 체크한 뒤 "선택 파일 병합" 클릭')}

// autosave
const autoSaveCb = document.getElementById('autoSave'); autoSaveCb.addEventListener('change', ()=>{ if(autoSaveCb.checked) startAutoSave(); else stopAutoSave();}); let autoSaveTimer=null;
function startAutoSave(){ if(autoSaveTimer) clearInterval(autoSaveTimer); autoSaveTimer = setInterval(()=>{ if(currentFileId) saveCurrent(); }, 3000);} function stopAutoSave(){ if(autoSaveTimer) clearInterval(autoSaveTimer); autoSaveTimer=null}

// keyboard shortcuts
document.addEventListener('keydown', e=>{
  if((e.ctrlKey||e.metaKey) && e.key==='s'){ e.preventDefault(); saveCurrent(); alert('저장됨'); }
  if((e.ctrlKey||e.metaKey) && e.key==='b'){ e.preventDefault(); doCmd('bold'); }
});

// editor change to update file name preview
document.getElementById('editor').addEventListener('input', ()=>{ if(currentFileId){ db.files[currentFileId].updated=Date.now(); }});

// helper: command
function doCmd(cmd, val=null){ document.execCommand(cmd, false, val); }

// toggle dark
let dark=false; document.getElementById('btnToggleDark').onclick = ()=>{ dark = !dark; if(dark){ document.documentElement.style.setProperty('--bg','#111316'); document.documentElement.style.setProperty('--card','#0f1417'); document.documentElement.style.setProperty('--muted','#9aa4ad'); } else { document.documentElement.style.setProperty('--bg','#f7f8fb'); document.documentElement.style.setProperty('--card','#fff'); document.documentElement.style.setProperty('--muted','#666'); }}

// download whole database
function exportAll(){ const blob = new Blob([JSON.stringify(db, null, 2)],{type:'application/json'}); saveAs(blob, 'web-notes-backup.json'); }

// import backup
async function importBackupFile(file){ const txt = await file.text(); try{ db = JSON.parse(txt); saveDB(); render(); alert('백업 복원됨'); }catch(e){alert('복원실패') } }

// utility: open first file
if(db.order.length) openFile(db.order[0]);
render();

// expose some functions for inline buttons
window.newFile=newFile; window.newFolder=newFolder; window.openFile=openFile; window.deleteFile=deleteFile; window.toggleStar=toggleStar; window.toggleSelect=toggleSelect; window.downloadTxt=downloadTxt; window.mergeSelected=mergeSelected; window.deleteSelected=deleteSelected; window.exportDocx=exportDocx; window.exportPdf=exportPdf; window.saveCurrent=saveCurrent; window.render=render; window.saveDB=saveDB;

</script>
</body>
</html>
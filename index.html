<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Static Web Notepad</title>
  <script src="https://cdn.jsdelivr.net/npm/html-docx-js@0.4.1/dist/html-docx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>

  <style>
    :root{--bg:#f7f8fb;--card:#fff;--muted:#666;--sidebar:#f8fafc;--accent:#0b66ff;--active-bg:#e9ecef}
    *{box-sizing:border-box}
    html{height:100%}
    body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:#111; display: flex; flex-direction: column; overflow: hidden;}
    .app{display:grid;grid-template-columns:300px 1fr;grid-template-rows:100%; flex-grow: 1; overflow: hidden; transition:grid-template-columns .25s ease}
    .app.sidebar-hidden{grid-template-columns:0 1fr}
    nav{background:var(--sidebar);border-right:1px solid #e6e9ef;padding:12px;overflow-y:auto; overflow-x: hidden; transition:transform .25s ease,width .25s}
    .app.sidebar-hidden nav{transform:translateX(-100%);padding:12px 0;border-right:none}
    header{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    header h2{margin:0;font-size:16px}
    .controls{display:flex;gap:6px;flex-wrap:wrap}
    button,select,input[type=text]{background:#fff;border:1px solid #ddd;padding:6px 8px;border-radius:6px;cursor:pointer}
    button.small{padding:6px}
    #mobileMenuBtn { display: none; }
    .list{margin-top:8px}
    .section-title{font-size:12px;color:var(--muted);margin:10px 0 6px}
    .folder, .file-item{padding:8px;border-radius:6px;margin-bottom:6px;display:flex;align-items:center;justify-content:space-between; border-left: 2px solid transparent;}
    .folder{background:linear-gradient(90deg,#fdfdfd,#fbfcff);border:1px solid #eee}
    .file-item{background:#fff;border:1px solid #f0f3f7}
    .file-item.draggable{cursor:grab}
    .file-item .meta{flex:1;overflow:hidden;display: flex;flex-direction: column;align-items: flex-start;gap: 2px;}
    .file-item .meta .name{font-weight:600;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;display: flex;align-items: center;gap: 4px;width: 100%;}
    .file-item .meta .sub{font-size:11px;color:var(--muted);padding-left: 2px;}
    .file-item .actions{display:flex;gap:6px;margin-left:8px}
    .folder.active-file, .file-item.active-file { background-color: var(--active-bg); border-left: 2px solid var(--accent); }
    main{display:flex;flex-direction:column;gap:8px;padding:12px;overflow:hidden; position: relative;}
    .toolbar{display:flex;gap:6px;align-items:center; flex-wrap: wrap; transition: padding-left .25s ease;}
    .app.sidebar-hidden .toolbar { padding-left: 48px; }
    .toolbar .group{display:flex;gap:6px;align-items:center;background:var(--card);padding:6px;border-radius:8px;border:1px solid #e9edf3; flex-shrink: 0;}
    #fileNameGroup { min-width: 250px; justify-content: space-between; }
    #fileNameDisplay { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .editor-container { position: relative; flex: 1; overflow: hidden; background: var(--card); border: 1px solid #e6e9ef; border-radius: 8px; display: flex; }
    #line-numbers { height: 100%; padding: 16px 8px 16px 16px; font-family: monospace; color: var(--muted); text-align: right; user-select: none; overflow: hidden; line-height: 1.5; font-size: 16px; background-color: var(--sidebar); border-right: 1px solid #e6e9ef; }
    #editor{ flex: 1; height:100%;padding:16px;overflow:auto;line-height:1.5;font-size: 16px;}
    #editor[contenteditable="true"]:focus{outline:none}
    .top-right-actions{margin-left:auto;display:flex;gap:8px;align-items:center}
    .btn-action{padding:6px 8px;border-radius:6px}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:200}
    .modal{background:var(--card);padding:16px;border-radius:8px;width:400px;box-shadow:0 6px 32px rgba(0,0,0,0.15);overflow-y: auto; max-height: 80vh;}
    #statsFooter{background:var(--bg); border-top:1px solid #e9edf3;padding:6px 12px;display:flex;gap:16px;align-items:center;font-size:12px;color:var(--muted); flex-wrap: wrap; flex-shrink: 0; z-index: 100;}
    #statsFooter span { font-weight: 500; color: #444; }
    .drop-target{outline:2px dashed var(--accent)}

    :root.dark{--bg:#2b2b2b;--card:#393939;--muted:#bfc4c8;--sidebar:#333437;--accent:#9fb8ff;--active-bg:#4f5154}
    
    body.dark .folder.active-file,
    body.dark .file-item.active-file {
      background-color: var(--active-bg);
      border-left: 2px solid var(--accent);
    }
    
    body.dark{background:var(--bg);color:#efefef}
    body.dark nav{background:var(--sidebar);border-color:#4a4a4a}
    body.dark .file-item, body.dark .folder{background:var(--card);border-color:#4a4a4a}
    body.dark button, body.dark select, body.dark input[type=text] {background:#5a5a5a;color:#eee;border-color:#666}
    body.dark .editor-container { background: var(--card); border-color: #4a4a4a;}
    body.dark #line-numbers { background-color: var(--bg); border-right: 1px solid #4a4a4a; }
    body.dark #statsFooter { border-color: #4a4a4a; color: var(--muted); background: var(--bg);}
    body.dark #statsFooter span { color: #ddd; }
    #expandHandle{position:absolute;left:8px;top:12px;width:36px;height:36px;border-radius:6px;background:var(--card);border:1px solid #ddd;display:none;align-items:center;justify-content:center;z-index:300;cursor:pointer}
    .app.sidebar-hidden #expandHandle{display:flex}
    #btnBookmark.bookmarked { background-color: #ffc107; color: #000; border-color: #f5b300;}
    .sidebar-backdrop { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 399; }
    
    body.editor-fullscreen #sidebar, body.editor-fullscreen .toolbar, body.editor-fullscreen #statsFooter, body.editor-fullscreen #expandHandle { display: none !important; }
    body.editor-fullscreen .app { grid-template-columns: 1fr !important; grid-template-rows: 1fr !important; height: 100vh; }
    body.editor-fullscreen main.editor-wrap { padding: 0; height: 100%; }
    body.editor-fullscreen .editor-container { height: 100%; border: 0; border-radius: 0; }

    #formattingToolbar { display: none; }
    #formattingToolbar.active { display: flex; }
    
    .snippet-list { display: flex; flex-direction: column; gap: 8px; }
    .snippet-item { display: flex; align-items: center; gap: 8px; padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
    .snippet-item input[type="text"] { flex-grow: 1; }
    .snippet-item .snippet-actions { display: flex; gap: 4px; }
    .snippet-actions button { padding: 4px 8px; font-size: 12px; }

    .modal-tab-container { display: flex; border-bottom: 1px solid #ccc; margin-bottom: 12px; }
    .modal-tab-button { flex: 1; padding: 10px; text-align: center; cursor: pointer; background: var(--bg); border: 1px solid transparent; border-bottom: none; border-radius: 8px 8px 0 0; }
    .modal-tab-button.active { background: var(--card); border-color: #ccc; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .tab-content h4 { margin-top: 0; }
    
    .snippet-item-grid { display: grid; grid-template-columns: 1fr 2fr auto; align-items: center; gap: 10px; padding: 6px; border: 1px solid #eee; border-radius: 4px; }
    .snippet-item-grid .snippet-key { font-weight: bold; }
    .snippet-item-grid .snippet-desc { color: var(--muted); }
    .snippet-item-grid .snippet-actions { display: flex; gap: 4px; }

    @media (max-width:800px){
        .app { grid-template-columns: 1fr; }
        .app.sidebar-hidden .toolbar { padding-left: 0; }
        #toggleSidebarBtn, #expandHandle { display: none !important; }
        #mobileMenuBtn { display: flex; align-items: center; justify-content: center; }
        nav { position: fixed; top: 0; left: 0; height: 100%; z-index: 400; transform: translateX(-100%); transition: transform .3s ease-in-out; border-right: 1px solid #e6e9ef; width: 300px; }
        nav.sidebar-open { transform: translateX(0); }
        .sidebar-backdrop.visible { display: block; }
        .toolbar { flex-wrap: nowrap; overflow-x: auto; padding-bottom: 8px; scrollbar-width: thin; }
    }
  </style>
</head>
<body id="bodyRoot">
  <div class="app" id="appRoot">
    <nav id="sidebar">
      <header>
        <h2>Notepad v1.5</h2>
        <div style="margin-left:auto;display:flex;gap:6px;align-items:center">
          <button class="small" id="toggleSidebarBtn" title="ÏÇ¨Ïù¥ÎìúÎ∞î Ïà®Í∏∞Í∏∞">‚óÄ</button>
          <button class="small" id="btnNewFile">+ÌååÏùº</button>
          <button class="small" id="btnNewFolder">+Ìè¥Îçî</button>
        </div>
      </header>

      <div class="controls">
        <input id="search" type="text" placeholder="Í≤ÄÏÉâ (ÌååÏùºÎ™Ö/ÎÇ¥Ïö©)" style="flex:1">
        <select id="filter"><option value="all">Ï†ÑÏ≤¥</option><option value="star">Î∂ÅÎßàÌÅ¨</option></select>
      </div>

      <div class="list">
        <div class="section-title">Ìè¥Îçî</div>
        <div id="folders" ondragover="allowDrop(event)" ondrop="onFolderContainerDrop(event)" ondragleave="onContainerDragLeave(event)"></div>
        <div class="section-title">ÌååÏùº</div>
        <div id="files" ondragover="allowDrop(event)" ondrop="onFileContainerDrop(event)" ondragleave="onContainerDragLeave(event)"></div>
      </div>

      <div style="margin-top:12px">
        <div class="section-title">ÏûÑÌè¨Ìä∏(.txt)</div>
        <input id="fileInput" type="file" multiple accept=".txt" />
        <div class="section-title" style="margin-top:12px">Î≥ëÌï©/Í¥ÄÎ¶¨</div>
        <button id="btnMerge">ÏÑ†ÌÉù ÌååÏùº Î≥ëÌï©</button>
        <button id="btnDeleteSelected">ÏÑ†ÌÉù ÏÇ≠Ï†ú</button>
      </div>
    </nav>

    <main class="editor-wrap">
      <div id="expandHandle" title="ÏÇ¨Ïù¥ÎìúÎ∞î ÌéºÏπòÍ∏∞">‚ñ∂</div>
      <div class="toolbar">
        <div class="group">
             <button id="mobileMenuBtn" class="btn-action">‚ò∞</button>
        </div>
        <div class="group" id="fileNameGroup">
          <h3 id="fileNameDisplay" style="margin: 0; font-size: 16px; font-weight: 600;"></h3>
          <button id="btnRenameFile" class="btn-action">Î≥ÄÍ≤Ω</button>
        </div>
        <div class="group" id="formattingToolbar">
          <button onmousedown="event.preventDefault()" onclick="doCmd('bold')"><b>B</b></button>
          <button onmousedown="event.preventDefault()" onclick="doCmd('italic')"><i>I</i></button>
          <button onmousedown="event.preventDefault()" onclick="doCmd('underline')"><u>U</u></button>
          <button onmousedown="event.preventDefault()" onclick="doCmd('strikeThrough')">S</button>
          <!-- MODIFIED: Color input changed to a button for palette -->
          <!-- <button onmousedown="event.preventDefault()" onclick="openColorPaletteModal()" title="Í∏ÄÏûêÏÉâ">üé®</button> -->
          <select id="fontSize">
            <option value="3">Í∏∞Î≥∏</option>
            <option value="4">ÌÅ¨Í≤å</option>
            <option value="5">Îçî ÌÅ¨Í≤å</option>
          </select>
        </div>
        <div class="group top-right-actions">
          <button id="btnExport" class="btn-action">ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>
          <button id="btnFindReplace" class="btn-action">Ï∞æÍ∏∞/Î∞îÍæ∏Í∏∞</button>
          <button id="btnBookmark" class="btn-action">‚≠ê</button>
          <button id="btnDeleteFile" class="btn-action">ÏÇ≠Ï†ú</button>
          <button id="btnSettings">ÏÑ§Ï†ï</button>
        </div>
      </div>
      <div class="editor-container">
        <div id="line-numbers"></div>
        <div id="editor" contenteditable="true" spellcheck="false"></div>
      </div>
    </main>
  </div>
  
  <footer id="statsFooter">
      Í∏ÄÏûê: <span id="statChars">0</span>
      Í≥µÎ∞± Ï†úÏô∏: <span id="statCharsNoSpace">0</span>
      Îã®Ïñ¥: <span id="statWords">0</span>
      Î¨∏Îã®: <span id="statParagraphs">0</span>
      Ï§Ñ: <span id="statLines">0</span>
      Î∞úÌëú Î∂ÑÎüâ: <span id="statSpeechTime">00:00:00</span>
      Ïö©Îüâ: <span id="statSize">0 B</span>
      <div id="viewControls" style="margin-left: auto; display: flex; align-items: center; gap: 8px;">
          <button id="zoomOutBtn" title="Ï∂ïÏÜå">-</button>
          <span id="zoomLevel" style="width: 40px; text-align: center;">100%</span>
          <button id="zoomInBtn" title="ÌôïÎåÄ">+</button>
          <button id="btnSnippetHelp" title="Ïä§ÎãàÌé´ ÎèÑÏõÄÎßê">?</button>
          <button id="fullscreenBtn" title="Ï†ÑÏ≤¥ÌôîÎ©¥" style="font-size: 16px;">‚õ∂</button>
      </div>
  </footer>

  <div class="sidebar-backdrop"></div>
  <div id="modalRoot" style="display:none"></div>

<script>
const DB_KEY = 'web_notepad_v1';
let db = {folders: {}, files: {}, order: [], folderOrder: []};
let selectedFiles = new Set();
let currentFileId = null;
let currentZoom = 1;
const BASE_FONT_SIZE = 16; // px

let enableFormatting = false;
let preservePasteFormat = false;
let enableSnippets = false;
let enableCalculator = true;
let userSnippets = [];

const presetSnippets = {
  '/date/': { keys: ['/date/', '/ÎÇ†Ïßú/'], desc: 'Ïò§Îäò ÎÇ†Ïßú (Ïòà: 2025-05-24)', value: () => { const d = new Date(); const year = d.getFullYear(); const month = String(d.getMonth() + 1).padStart(2, '0'); const day = String(d.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }, enabled: true },
  '/time/': { keys: ['/time/', '/ÏãúÍ∞Ñ/'], desc: 'ÌòÑÏû¨ ÏãúÍ∞Ñ (Ïòà: 22:30)', value: () => { const now = new Date(); return String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0'); }, enabled: true },
  '/datetime/': { keys: ['/datetime/', '/ÏùºÏãú/'], desc: 'ÎÇ†Ïßú + ÏãúÍ∞Ñ (Ïòà: 2025-05-24 22:30)', value: () => { const now = new Date(); return now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0') + ' ' + String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0'); }, enabled: true },
  '/weekday/': { keys: ['/weekday/', '/ÏöîÏùº/'], desc: 'ÏöîÏùº (Ïòà: Wed)', value: () => { const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']; return weekdays[new Date().getDay()]; }, enabled: true },
  '/month/': { keys: ['/month/'], desc: 'ÌòÑÏû¨ Îã¨ ÏòÅÎ¨∏ Ïù¥Î¶Ñ (Ïòà: May)', value: () => { const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']; return months[new Date().getMonth()]; }, enabled: true },
  '/Îã¨/': { keys: ['/Îã¨/'], desc: 'ÌòÑÏû¨ Îã¨ ÌïúÍ∏Ä Ïù¥Î¶Ñ (Ïòà: 5Ïõî)', value: () => { const months = ['1Ïõî', '2Ïõî', '3Ïõî', '4Ïõî', '5Ïõî', '6Ïõî', '7Ïõî', '8Ïõî', '9Ïõî', '10Ïõî', '11Ïõî', '12Ïõî']; return months[new Date().getMonth()]; }, enabled: true },
  '/line/': { keys: ['/line/', '/ÏÑ†/'], desc: '---------- (Íµ¨Î∂ÑÏÑ†)', value: '--------------------------------------------------', enabled: true },
  '/lines/': { keys: ['/lines/', '/Í∏¥ÏÑ†/'], desc: '========== (Íµ¨Î∂ÑÏÑ†)', value: '==================================================', enabled: true },
  '/clip/': { keys: ['/clip/', '/Î≥µÎ∂ô/'], desc: 'ÌòÑÏû¨ ÌÅ¥Î¶ΩÎ≥¥Îìú ÎÇ¥Ïö© ÏÇΩÏûÖ', value: async () => { try { if (!navigator.clipboard || !navigator.clipboard.readText) { return '[ÌÅ¥Î¶ΩÎ≥¥Îìú Ï†ëÍ∑ºÏù¥ ÏßÄÏõêÎêòÏßÄ ÏïäÏäµÎãàÎã§]'; } const text = await navigator.clipboard.readText(); return text || '[ÌÅ¥Î¶ΩÎ≥¥ÎìúÍ∞Ä ÎπÑÏñ¥ÏûàÏäµÎãàÎã§]'; } catch (err) { console.error('ÌÅ¥Î¶ΩÎ≥¥Îìú ÏùΩÍ∏∞ Ïã§Ìå®:', err); return '[ÌÅ¥Î¶ΩÎ≥¥ÎìúÎ•º ÏùΩÏñ¥Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÌÅ¥Î¶≠ÌïòÎäî Îì± ÏÉÅÌò∏ÏûëÏö© ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Î≥¥ÏÑ∏Ïöî.]'; } }, enabled: true },
  '/rand/': { keys: ['/rand/', '/ÎûúÎç§/'], desc: 'Î¨¥ÏûëÏúÑ Ïà´Ïûê(1~100)', value: () => Math.floor(Math.random() * 100) + 1, enabled: true },
  '/lotto/': { keys: ['/lotto/', '/Î°úÎòê/'], desc: 'Î°úÎòê Î≤àÌò∏(1~45) 6Í∞ú ÎûúÎç§ ÏÉùÏÑ±', value: () => { const numbers = new Set(); while (numbers.size < 6) { numbers.add(Math.floor(Math.random() * 45) + 1); } return Array.from(numbers).sort((a, b) => a - b).join(', '); }, enabled: true },
  '/w/': { keys: ['/w/', '/ÏÉÅ/'], desc: '‚Üë', value: '‚Üë', enabled: true },
  '/s/': { keys: ['/s/', '/Ìïò/'], desc: '‚Üì', value: '‚Üì', enabled: true },
  '/a/': { keys: ['/a/', '/Ï¢å/'], desc: '‚Üê', value: '‚Üê', enabled: true },
  '/d/': { keys: ['/d/', '/Ïö∞/'], desc: '‚Üí', value: '‚Üí', enabled: true },
  '/ws/': { keys: ['/ws/', '/ÏÉÅÌïò/'], desc: '‚Üï', value: '‚Üï', enabled: true },
  '/ad/': { keys: ['/ad/', '/Ï¢åÏö∞/'], desc: '‚Üî', value: '‚Üî', enabled: true },
  '/yyyymmdd/': { keys: ['/yyyymmdd/'], desc: 'ÎÖÑÏõîÏùº(8ÏûêÎ¶¨)', value: () => { const d = new Date(); return d.getFullYear().toString() + String(d.getMonth() + 1).padStart(2, '0') + String(d.getDate()).padStart(2, '0'); }, enabled: true },
  '/yymmdd/': { keys: ['/yymmdd/'], desc: 'ÎÖÑÏõîÏùº(6ÏûêÎ¶¨)', value: () => { const d = new Date(); return d.getFullYear().toString().slice(2) + String(d.getMonth() + 1).padStart(2, '0') + String(d.getDate()).padStart(2, '0'); }, enabled: true },
  '/ddmmyy/': { keys: ['/ddmmyy/'], desc: 'ÏùºÏõîÎÖÑ(6ÏûêÎ¶¨)', value: () => { const d = new Date(); return String(d.getDate()).padStart(2, '0') + String(d.getMonth() + 1).padStart(2, '0') + d.getFullYear().toString().slice(2); }, enabled: true },
  '/ddmmyyyy/': { keys: ['/ddmmyyyy/'], desc: 'ÏùºÏõîÎÖÑ(8ÏûêÎ¶¨)', value: () => { const d = new Date(); return String(d.getDate()).padStart(2, '0') + String(d.getMonth() + 1).padStart(2, '0') + d.getFullYear().toString(); }, enabled: true },
  '/hhmmss/': { keys: ['/hhmmss/'], desc: 'ÏãúÎ∂ÑÏ¥à(6ÏûêÎ¶¨)', value: () => { const d = new Date(); return String(d.getHours()).padStart(2, '0') + String(d.getMinutes()).padStart(2, '0') + String(d.getSeconds()).padStart(2, '0'); }, enabled: true },
};

function loadDB(){ 
  const raw = localStorage.getItem(DB_KEY); 
  if(raw) {
    try{
      const loadedDb = JSON.parse(raw);
      db = { 
        ...db, 
        ...loadedDb,
        folders: loadedDb.folders || {},
        files: loadedDb.files || {},
        order: loadedDb.order || [],
        folderOrder: loadedDb.folderOrder || []
      };
      for(const folderId in db.folders) {
        if (!db.folders[folderId].fileOrder) {
            db.folders[folderId].fileOrder = Object.keys(db.files).filter(fid => db.files[fid].folder === folderId);
        }
      }
      enableFormatting = loadedDb.settings?.enableFormatting || false;
      preservePasteFormat = loadedDb.settings?.preservePasteFormat || false;
      enableSnippets = loadedDb.settings?.enableSnippets || false;
      enableCalculator = loadedDb.settings?.enableCalculator === false ? false : true;
      userSnippets = loadedDb.settings?.userSnippets || [];
      
      if(loadedDb.settings && loadedDb.settings.presetSnippets){
        Object.keys(presetSnippets).forEach(key => {
          if(loadedDb.settings.presetSnippets[key] !== undefined){
            presetSnippets[key].enabled = loadedDb.settings.presetSnippets[key];
          }
        });
      }

    } catch(e){
      console.error(e);
      db = {folders: {}, files: {}, order: [], folderOrder: []}; 
    }
  }
}
function saveDB(){ 
  const presetState = {};
  Object.keys(presetSnippets).forEach(key => {
    presetState[key] = presetSnippets[key].enabled;
  });
  db.settings = { enableFormatting, preservePasteFormat, enableSnippets, enableCalculator, userSnippets, presetSnippets: presetState };
  localStorage.setItem(DB_KEY, JSON.stringify(db)); 
}
function uid(prefix='f'){return prefix+Date.now().toString(36)+Math.random().toString(36).slice(2,8)}
loadDB();
if(Object.keys(db.files).length===0){ const id = uid(); db.files[id] = {id,name:'ÏÉà Î¨∏ÏÑú',content:'',folder:null,star:false,created:Date.now(),updated:Date.now()}; db.order.push(id); saveDB();}

let dragId = null, dragType = null;
function allowDrop(e){ e.preventDefault(); e.currentTarget.classList.add('drop-target'); }
function onContainerDragLeave(e) { e.currentTarget.classList.remove('drop-target'); }
function onDragStart(ev, id, type){ dragId = id; dragType = type; ev.dataTransfer.setData('text/plain', id); ev.dataTransfer.effectAllowed = 'move'; }
function cleanupDragState() { document.querySelectorAll('.drop-target').forEach(el => el.classList.remove('drop-target')); dragId = null; dragType = null;}

function onDrop(ev, targetId) {
    ev.preventDefault();
    ev.stopPropagation();
    
    // Case 1: Dropping a file onto a folder element.
    if (dragType === 'file' && db.folders[targetId]) {
        const folderId = targetId;
        const file = db.files[dragId];

        if (file.folder === folderId) {
             cleanupDragState();
             return;
        }

        if (file.folder) {
            const oldFolder = db.folders[file.folder];
            if (oldFolder && oldFolder.fileOrder) {
                oldFolder.fileOrder = oldFolder.fileOrder.filter(id => id !== dragId);
            }
        } else {
            db.order = db.order.filter(id => id !== dragId);
        }

        file.folder = folderId;
        file.updated = Date.now();

        const targetFolder = db.folders[folderId];
        if (!targetFolder.fileOrder) targetFolder.fileOrder = [];
        if (!targetFolder.fileOrder.includes(dragId)) targetFolder.fileOrder.push(dragId);
        
        saveDB();
        render();
        cleanupDragState();
        return;
    }

    const targetFile = db.files[targetId];
    const draggedFile = db.files[dragId];

    // Case 2: Reordering files
    if (dragType === 'file' && draggedFile && targetFile) {
        if(draggedFile.folder) {
            const folder = db.folders[draggedFile.folder];
            if (folder && folder.fileOrder) {
                folder.fileOrder = folder.fileOrder.filter(id => id !== dragId);
            }
        } else {
            db.order = db.order.filter(id => id !== dragId);
        }

        draggedFile.folder = targetFile.folder;
        reorderFile(dragId, targetId, targetFile.folder);
    
    // Case 3: Reordering folders
    } else if (dragType === 'folder') {
        const arr = db.folderOrder; 
        const idx = arr.indexOf(dragId); 
        if(idx>-1) arr.splice(idx,1); 
        if(targetId && db.folders[targetId]){ 
            const ti = arr.indexOf(targetId); 
            arr.splice(ti,0,dragId); 
        } else { 
            arr.push(dragId); 
        } 
        db.folderOrder = arr; 
    }

    saveDB(); 
    render(); 
    cleanupDragState();
}

function reorderFile(draggedId, targetId, folderId = null) {
    const list = folderId ? db.folders[folderId].fileOrder : db.order;
    const dragIndex = list.indexOf(draggedId);
    if(dragIndex > -1) list.splice(dragIndex, 1);

    if (targetId) {
        const targetIndex = list.indexOf(targetId);
        if(targetIndex > -1) list.splice(targetIndex, 0, draggedId);
        else list.push(draggedId);
    } else {
        list.push(draggedId);
    }
}


function onFileContainerDrop(ev) { 
    ev.preventDefault(); 
    if (dragType === 'file') { 
        const file = db.files[dragId]; 
        if (file.folder) {
            const oldFolder = db.folders[file.folder];
            if(oldFolder && oldFolder.fileOrder) {
                oldFolder.fileOrder = oldFolder.fileOrder.filter(id => id !== dragId);
            }
            file.folder = null; 
        }
        reorderFile(dragId, null, null); 
        saveDB();
        render(); 
    } 
    cleanupDragState(); 
}

function onFolderDrop(ev, folderId){ 
    ev.preventDefault(); 
    ev.stopPropagation(); 
    if(dragType==='file' && dragId && db.files[dragId]){ 
        const file = db.files[dragId];
        if (file.folder && db.folders[file.folder] && db.folders[file.folder].fileOrder) {
            db.folders[file.folder].fileOrder = db.folders[file.folder].fileOrder.filter(id => id !== dragId);
        } else {
            db.order = db.order.filter(id => id !== dragId);
        }

        file.folder = folderId; 
        file.updated = Date.now(); 
        
        const targetFolder = db.folders[folderId];
        if (!targetFolder.fileOrder) {
            targetFolder.fileOrder = [];
        }
        targetFolder.fileOrder.push(dragId);

        saveDB(); 
        render(); 
    } 
    cleanupDragState();
}

function onFolderContainerDrop(ev) { ev.preventDefault(); if (dragType === 'folder') { reorderFile(dragId, null); render(); } cleanupDragState(); }

function render(){ renderFolders(); renderFiles(); updateBookmarkButtonState(); updateFormattingToolbar();}
function renderFileItem(file) { const starIcon = file.star ? '‚≠ê' : ''; return `<div class="meta"><div class="name">${starIcon} ${escapeHtml(file.name)}</div><div class="sub">${new Date(file.updated).toLocaleString('ko-KR', {dateStyle: 'short', timeStyle: 'short'})}</div></div><div class="actions"><input type="checkbox" onchange="toggleSelect(event,'${file.id}')" ${selectedFiles.has(file.id)?'checked':''}></div>`;}
function renderFolders(){
  const cont = document.getElementById('folders'); cont.innerHTML=''; const order = db.folderOrder || []; const currentFile = db.files[currentFileId];
  order.forEach(fid=>{
    const f = db.folders[fid]; if(!f) return;
    const el = document.createElement('div'); el.className='folder'; el.draggable = true; el.dataset.id = f.id;
    if(currentFile && currentFile.folder === f.id) { el.classList.add('active-file'); }
    const toggleIcon = f._open ? '‚ñæ' : '‚ñ∏';
    el.innerHTML = `<div style="flex:1;display:flex;align-items:center;gap:8px"><button onclick="toggleFolder('${f.id}')" style="width:24px;">${toggleIcon}</button><div style=\"flex:1;cursor:pointer\" onclick=\"handleMobileFileOpen(event, () => toggleFolder('${f.id}'))\">${escapeHtml(f.name)}</div></div><div style="display:flex;gap:6px"><button onclick="renameFolder('${f.id}')">‚úèÔ∏è</button><button onclick="deleteFolder('${f.id}')">üóëÔ∏è</button></div>`;
    el.ondragstart = (ev)=>onDragStart(ev, f.id, 'folder'); el.ondragover = allowDrop; el.ondragleave = (ev) => ev.currentTarget.classList.remove('drop-target'); el.ondrop = (ev) => onDrop(ev, f.id);
    const children = document.createElement('div'); children.className = 'folder-children'; children.id = 'children-'+f.id; children.style.display = f._open? 'block':'none';
    
    (f.fileOrder || []).forEach(fileId => {
        const file = db.files[fileId];
        if (file) {
            const fi = document.createElement('div'); 
            fi.className='file-item draggable'; 
            fi.dataset.id = file.id; 
            if(file.id === currentFileId) { fi.classList.add('active-file'); } 
            fi.innerHTML = renderFileItem(file); 
            fi.onclick = (e) => { if(e.target.type !== 'checkbox') handleMobileFileOpen(e, () => openFile(file.id)); }; 
            fi.draggable=true; 
            fi.ondragstart=(ev)=>onDragStart(ev,file.id,'file'); 
            fi.ondragover=allowDrop;
            fi.ondrop=(ev)=>onDrop(ev, file.id);
            children.appendChild(fi); 
        }
    });

    cont.appendChild(el); cont.appendChild(children);
  });
}
function renderFiles(){
  const cont = document.getElementById('files'); cont.innerHTML=''; const q = document.getElementById('search').value.toLowerCase(); const filter = document.getElementById('filter').value;
  (db.order || []).forEach(id=>{
    const f = db.files[id]; if(!f || f.folder) return; if(filter==='star' && !f.star) return; if(q && !(f.name.toLowerCase().includes(q) || stripTags(f.content).toLowerCase().includes(q))) return
    const div = document.createElement('div'); div.className='file-item draggable'; div.dataset.id = f.id; if(f.id === currentFileId) { div.classList.add('active-file'); } div.innerHTML = renderFileItem(f); div.onclick = (e) => { if(e.target.type !== 'checkbox') handleMobileFileOpen(e, () => openFile(id)); }; div.draggable = true; div.ondragstart = (ev)=>onDragStart(ev, f.id, 'file'); div.ondragover = allowDrop; div.ondragleave = (ev) => ev.currentTarget.classList.remove('drop-target'); div.ondrop = (ev) => onDrop(ev, f.id);
    cont.appendChild(div);
  })
}

function handleMobileFileOpen(event, openFn) { openFn(); if (window.innerWidth <= 800) { toggleMobileSidebar(false); } }
function escapeHtml(s){return (s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c])}
function stripTags(html){return html.replace(/<[^>]+>/g,'')}
function newFile(){ const name = prompt('ÏÉà ÌååÏùº Ïù¥Î¶Ñ:'); if(!name || name.trim() === '') return; const id=uid(); db.files[id]={id,name:name.trim(),content:'<div><br></div>',folder:null,star:false,created:Date.now(),updated:Date.now()}; db.order.unshift(id); saveDB(); render(); openFile(id); }
function newFolder(){ const name = prompt('Ìè¥Îçî Ïù¥Î¶Ñ:'); if(!name) return; const id=uid('d'); db.folders[id]={id,name, fileOrder:[]}; if(!db.folderOrder) db.folderOrder=[]; db.folderOrder.push(id); saveDB(); render(); }
function toggleFolder(id){ db.folders[id]._open = !db.folders[id]._open; saveDB(); render(); }

function renameFolder(id){ const name = prompt('ÏÉà Ìè¥Îçî Ïù¥Î¶Ñ:', db.folders[id].name); if(!name) return; db.folders[id].name=name; saveDB(); render(); }
function deleteFolder(id){ if(!confirm('Ìè¥ÎçîÏôÄ Í∑∏ ÏïàÏùò ÌååÏùºÎì§ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†Ïñ¥Ïöî?')) return; Object.values(db.files).forEach(f=>{if(f.folder===id) delete db.files[f.id];}); delete db.folders[id]; db.folderOrder = (db.folderOrder||[]).filter(x=>x!==id); db.order = db.order.filter(x=>db.files[x]); saveDB(); render(); }

function openFile(id){ 
    saveCurrent();
    currentFileId = id; 
    const f = db.files[id]; 
    if(f) {
        document.getElementById('editor').innerHTML = f.content || '<div><br></div>'; 
        document.getElementById('fileNameDisplay').textContent = f.name || ''; 
        render(); 
        updateStats(); 
    }
}

function renameCurrentFile(){ if(!currentFileId) return; const currentName = db.files[currentFileId].name; const newName = prompt('ÏÉà ÌååÏùº Ïù¥Î¶Ñ:', currentName); if(!newName || newName.trim() === '') return alert('Ïù¥Î¶ÑÏùÑ ÎπÑÏö∏ Ïàò ÏóÜÏäµÎãàÎã§'); db.files[currentFileId].name = newName.trim(); db.files[currentFileId].updated = Date.now(); saveDB(); render(); document.getElementById('fileNameDisplay').textContent = newName.trim(); }

function saveCurrent() {
    if (!currentFileId) return;
    const editor = document.getElementById('editor');
    if (!editor) return; 
    const content = editor.innerHTML;
    const f = db.files[currentFileId];
    
    if (!f) return;
    if (f.content === content) return;

    f.content = content;
    f.updated = Date.now();
    if (!f.name || f.name === 'Î¨¥Ï†ú') {
        const t = stripTags(content).slice(0, 30).trim();
        if (t) {
            f.name = t;
            document.getElementById('fileNameDisplay').textContent = f.name;
        }
    }
    saveDB();
    render(); 
}

function deleteFileById(id){ if(!confirm('ÌååÏùºÏùÑ ÏÇ≠Ï†úÌï†ÍπåÏöî?')) return; delete db.files[id]; db.order = db.order.filter(x=>x!==id); if(currentFileId===id){ currentFileId=null; document.getElementById('editor').innerHTML=''; document.getElementById('fileNameDisplay').textContent=''; updateStats(); } saveDB(); render(); }
function deleteCurrentFile(){ if(!currentFileId) return alert('ÌååÏùº ÏÑ†ÌÉù'); deleteFileById(currentFileId); }
function toggleSelect(ev,id){ if(ev.target.checked) selectedFiles.add(id); else selectedFiles.delete(id); }

const fileInput = document.getElementById('fileInput');
fileInput.addEventListener('change', async e => {
    const files = e.target.files;
    if (!files) return;

    for (const file of files) {
        if (file.type === 'text/plain') {
            try {
                const content = await file.text();
                const htmlContent = '<div>' + content.split('\n').join('</div><div>') + '</div>';
                const id = uid();
                const fileName = file.name.replace(/\.[^/.]+$/, "");
                db.files[id] = {
                    id,
                    name: fileName,
                    content: htmlContent,
                    folder: null,
                    star: false,
                    created: Date.now(),
                    updated: Date.now()
                };
                db.order.unshift(id);
            } catch (err) {
                console.error('File read error:', err);
                alert(`'${file.name}' ÌååÏùºÏùÑ ÏùΩÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.`);
            }
        } else {
            alert(`'${file.name}' ÌååÏùºÏùÄ ÏßÄÏõêÎêòÏßÄ ÏïäÎäî ÌòïÏãùÏûÖÎãàÎã§. .txt ÌååÏùºÎßå Í∞ÄÏ†∏Ïò¨ Ïàò ÏûàÏäµÎãàÎã§.`);
        }
    }
    
    saveDB();
    render();
    
    if (files.length > 0 && db.order.length > 0) {
        openFile(db.order[0]);
    }

    e.target.value = ''; 
});

function mergeSelected(){ if(selectedFiles.size<2) return alert('Îëê Í∞ú Ïù¥ÏÉÅÏùò ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî'); const ids = Array.from(selectedFiles); let merged=''; let name='Î≥ëÌï©Î¨∏ÏÑú'; ids.forEach(id=>{const f=db.files[id]; merged += `<h3>${escapeHtml(f.name)}</h3>` + (f.content||'') + '<hr>';}); const id = uid(); db.files[id]={id,name: name,content:merged,folder:null,star:false,created:Date.now(),updated:Date.now()}; db.order.push(id); saveDB(); render(); openFile(id); selectedFiles.clear(); }
function deleteSelected(){ 
    if(selectedFiles.size === 0) return alert('ÏÑ†ÌÉùÎêú ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§'); 
    if(!confirm(`${selectedFiles.size}Í∞úÏùò ÌååÏùºÏùÑ ÏÇ≠Ï†úÌï†ÍπåÏöî?`)) return; 

    const currentFileWasDeleted = selectedFiles.has(currentFileId);

    selectedFiles.forEach(id => {
        const file = db.files[id];
        if (file.folder) {
            const folder = db.folders[file.folder];
            if (folder && folder.fileOrder) {
                folder.fileOrder = folder.fileOrder.filter(fileId => fileId !== id);
            }
        }
        delete db.files[id];
        db.order = db.order.filter(x => x !== id);
    });
    
    if (currentFileWasDeleted) {
        currentFileId = null;
    }
    
    selectedFiles.clear();
    saveDB(); 

    if (currentFileWasDeleted) {
        const nextFileToOpen = db.order[0] || Object.keys(db.files)[0];

        if (nextFileToOpen) {
            openFile(nextFileToOpen);
        } else {
            document.getElementById('editor').innerHTML = '';
            document.getElementById('fileNameDisplay').textContent = '';
            updateStats();
        }
    }
    
    render();
}

// MODIFIED: Robust line counting for Enter and Shift+Enter
function updateLineNumbers() {
  const editor = document.getElementById('editor');
  const lineNumbersEl = document.getElementById('line-numbers');
  
  let lineCount = 0;
  const children = editor.childNodes;
  for (let i = 0; i < children.length; i++) {
      const node = children[i];
      // Count DIV elements as lines
      if (node.nodeName === 'DIV') {
          // Inside a div, count <br> tags to handle shift+enter
          const brs = node.getElementsByTagName('br').length;
          // A div with no <br> or one <br> is one line. More <br>s add more lines.
          lineCount += Math.max(1, brs);
      }
  }
  
  // If the editor is empty or has no divs, it's still one line
  if (lineCount === 0) {
      lineCount = 1;
  }

  const numbersHTML = Array.from({length: lineCount}, (_, i) => i + 1).join('<br>'); 
  lineNumbersEl.innerHTML = numbersHTML; 
  lineNumbersEl.scrollTop = editor.scrollTop;
  return lineCount;
}

function updateStats() { 
  const editor = document.getElementById('editor'); 
  // MODIFIED: Normalize newlines to fix character count issue
  const text = (editor.innerText || '').replace(/\r\n/g, '\n');
  const html = editor.innerHTML || ''; 
  
  let chars = text.length;
  
  const charsNoSpace = text.replace(/\s/g, '').length;
  const words = (text.match(/\S+/g) || []).length;
  const paragraphs = (text.split('\n').filter(line => line.trim() !== '')).length;

  document.getElementById('statChars').textContent = chars.toLocaleString(); 
  document.getElementById('statCharsNoSpace').textContent = charsNoSpace.toLocaleString(); 
  document.getElementById('statWords').textContent = words.toLocaleString(); 
  document.getElementById('statParagraphs').textContent = paragraphs.toLocaleString(); 
  
  const koreanRate = 250; 
  const englishRate = 130; 
  
  const isKorean = /[Í∞Ä-Ìû£]/.test(text);
  
  let totalTimeInMinutes = 0;
  if (isKorean) {
      const koreanChars = text.replace(/[\s\n\r]/g, '');
      totalTimeInMinutes = koreanChars.length / koreanRate;
  } else {
      totalTimeInMinutes = words / englishRate;
  }

  const totalSeconds = Math.round(totalTimeInMinutes * 60);
  const h = Math.floor(totalSeconds / 3600);
  const m = Math.floor((totalSeconds % 3600) / 60);
  const s = totalSeconds % 60;
  
  const formattedTime = [h, m, s].map(v => v.toString().padStart(2, '0')).join(':');
  document.getElementById('statSpeechTime').textContent = formattedTime;

  const sizeInBytes = new Blob([html]).size; 
  let size = `${sizeInBytes} B`; 
  if (sizeInBytes >= 1024 * 1024) size = `${(sizeInBytes / (1024 * 1024)).toFixed(2)} MB`; 
  else if (sizeInBytes >= 1024) size = `${(sizeInBytes / 1024).toFixed(1)} KB`; 
  document.getElementById('statSize').textContent = size; 

  const lineCount = updateLineNumbers(); 
  document.getElementById('statLines').textContent = lineCount.toLocaleString(); 
}

document.getElementById('btnNewFile').onclick = newFile; document.getElementById('btnNewFolder').onclick = newFolder; document.getElementById('btnRenameFile').onclick = renameCurrentFile; document.getElementById('search').addEventListener('input', render); document.getElementById('filter').addEventListener('change', render);
document.getElementById('btnExport').onclick = ()=>{ openSaveExportModal(); }; document.getElementById('btnMerge').onclick = mergeSelected; document.getElementById('btnDeleteSelected').onclick = deleteSelected;

const editorEl = document.getElementById('editor');
editorEl.addEventListener('input', ()=>{ if(currentFileId) { db.files[currentFileId].updated=Date.now(); } updateStats(); });
editorEl.addEventListener('scroll', () => { document.getElementById('line-numbers').scrollTop = editorEl.scrollTop; });

// ADDED: Copy only plain text, removing all formatting
editorEl.addEventListener('copy', e => {
    e.preventDefault();
    const textToCopy = window.getSelection().toString();
    e.clipboardData.setData('text/plain', textToCopy);
});

editorEl.addEventListener('paste', e => { 
  if (!preservePasteFormat) {
    e.preventDefault(); 
    const text = (e.clipboardData || window.clipboardData).getData('text/plain'); 
    document.execCommand('insertText', false, text); 
  }
});

editorEl.addEventListener('keydown', async (e) => {
    if (!enableSnippets && !enableCalculator) return;

    if (e.key !== ' ') return;

    const selection = window.getSelection();
    if (!selection.rangeCount) return;
    const range = selection.getRangeAt(0);
    if (!range.collapsed) return;
    const textNode = range.startContainer;
    if (textNode.nodeType !== Node.TEXT_NODE) return;
    const textBeforeCursor = textNode.textContent.substring(0, range.startOffset);

    let isSnippetFound = false;
    let replacementText = '';
    let triggerLength = 0;
    
    // Calculator logic
    if (enableCalculator) {
        const calcMatch = textBeforeCursor.match(/=([0-9+\-*/\s.()**]+)=$/);
        if (calcMatch) {
            const expr = calcMatch[1];
            try {
                replacementText = String(eval(expr));
                if (isNaN(replacementText)) replacementText = 'Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ÏàòÏãù';
            } catch (err) {
                replacementText = 'Í≥ÑÏÇ∞ Ïò§Î•ò';
            }
            triggerLength = calcMatch[0].length;
            isSnippetFound = true;
        }
    }

    // General snippet logic
    if (!isSnippetFound && enableSnippets) {
        const snippetKeys = Object.values(presetSnippets).flatMap(s => s.enabled ? s.keys : []);
        const userSnippetTriggers = userSnippets.filter(s => s.enabled).map(s => s.trigger);
        const allTriggers = [...snippetKeys, ...userSnippetTriggers].sort((a, b) => b.length - a.length);
        const foundTrigger = allTriggers.find(trigger => textBeforeCursor.endsWith(trigger));

        if (foundTrigger) {
            const preset = Object.values(presetSnippets).find(s => s.keys.includes(foundTrigger));
            const user = userSnippets.find(s => s.trigger === foundTrigger);
            const snippetValue = preset ? preset.value : user.value;

            replacementText = await Promise.resolve(
                typeof snippetValue === 'function' ? snippetValue() : snippetValue
            );
            replacementText = String(replacementText || '');
            triggerLength = foundTrigger.length;
            isSnippetFound = true;
        }
    }

    if (isSnippetFound) {
        e.preventDefault();
        
        // Timeout helps with IME composition issues
        setTimeout(() => {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;
            const range = selection.getRangeAt(0);
            const textNode = range.startContainer;

            if (textNode.nodeType !== Node.TEXT_NODE) return;
            const cursorPos = range.startOffset;
            if (cursorPos < triggerLength) return;

            const triggerRange = document.createRange();
            triggerRange.setStart(textNode, cursorPos - triggerLength);
            triggerRange.setEnd(textNode, cursorPos);
            
            selection.removeAllRanges();
            selection.addRange(triggerRange);
            document.execCommand('insertText', false, replacementText);
        }, 0);
    }
});

const appRoot = document.getElementById('appRoot'); const toggleSidebarBtn = document.getElementById('toggleSidebarBtn'); const expandHandle = document.getElementById('expandHandle');
function toggleSidebar() { const isHidden = appRoot.classList.toggle('sidebar-hidden'); toggleSidebarBtn.textContent = isHidden ? '‚ñ∂' : '‚óÄ'; toggleSidebarBtn.title = isHidden ? 'ÏÇ¨Ïù¥ÎìúÎ∞î ÌéºÏπòÍ∏∞' : 'ÏÇ¨Ïù¥ÎìúÎ∞î Ïà®Í∏∞Í∏∞'; }
toggleSidebarBtn.addEventListener('click', toggleSidebar); expandHandle.addEventListener('click', toggleSidebar);

const sidebar = document.getElementById('sidebar');
const backdrop = document.querySelector('.sidebar-backdrop');
function toggleMobileSidebar(forceOpen) {
    const isOpen = sidebar.classList.contains('sidebar-open');
    if (typeof forceOpen === 'boolean') {
        sidebar.classList.toggle('sidebar-open', forceOpen);
        backdrop.classList.toggle('visible', forceOpen);
    } else {
        sidebar.classList.toggle('sidebar-open');
        backdrop.classList.toggle('visible');
    }
}
document.getElementById('mobileMenuBtn').addEventListener('click', () => toggleMobileSidebar());
backdrop.addEventListener('click', () => toggleMobileSidebar(false));

document.getElementById('btnSettings').addEventListener('click', ()=>{ openMainSettingsModal(); }); 
document.getElementById('btnSnippetHelp').addEventListener('click', () => { openSnippetModal(); });
document.getElementById('btnDeleteFile').onclick = deleteCurrentFile; 
document.getElementById('btnBookmark').onclick = toggleBookmark; 
document.getElementById('btnFindReplace').onclick = openFindReplaceModal;
document.getElementById('zoomInBtn').onclick = () => { currentZoom = Math.min(10, currentZoom + 0.2); updateZoom(); }
document.getElementById('zoomOutBtn').onclick = () => { currentZoom = Math.max(0.2, currentZoom - 0.2); updateZoom(); }
document.getElementById('fullscreenBtn').onclick = () => { const editorContainer = document.querySelector('.editor-container'); if (!document.fullscreenElement) { editorContainer.requestFullscreen(); } else { document.exitFullscreen(); } }
document.addEventListener('fullscreenchange', () => { if (document.fullscreenElement) { document.body.classList.add('editor-fullscreen'); } else { document.body.classList.remove('editor-fullscreen'); } });
function updateZoom() { const newSize = BASE_FONT_SIZE * currentZoom; editorEl.style.fontSize = `${newSize}px`; document.getElementById('line-numbers').style.fontSize = `${newSize}px`; document.getElementById('zoomLevel').textContent = `${Math.round(currentZoom * 100)}%`; }

function toggleBookmark() { if (!currentFileId) return alert('ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî'); const file = db.files[currentFileId]; file.star = !file.star; file.updated = Date.now(); saveDB(); render(); }
function updateBookmarkButtonState() { const btn = document.getElementById('btnBookmark'); if (currentFileId && db.files[currentFileId] && db.files[currentFileId].star) { btn.classList.add('bookmarked'); } else { btn.classList.remove('bookmarked'); }}

function doCmd(cmd, val = null){ 
  if (enableFormatting) {
    document.execCommand(cmd, false, val); 
  } else {
    console.log("Formatting is currently disabled.");
  }
}

document.getElementById('fontSize').addEventListener('change', (e) => {
    doCmd('fontSize', e.target.value);
});


let dark=false; function applyDark(d){ dark = !!d; document.documentElement.classList.toggle('dark', dark); document.body.classList.toggle('dark', dark); localStorage.setItem('wn_dark', dark? '1':'0'); }
window.addEventListener('dragend', cleanupDragState);
if(localStorage.getItem('wn_dark')==='1') applyDark(true);
if(db.order && db.order.length > 0 && db.files[db.order[0]]) { openFile(db.order[0]); } else if (Object.keys(db.files).length > 0) { openFile(Object.keys(db.files)[0]); } else { updateStats(); }
render();
setInterval(saveCurrent, 1500);

function openModal(contentHtml){ const root = document.getElementById('modalRoot'); root.innerHTML = `<div class="modal-backdrop"> <div class="modal">${contentHtml}</div> </div>`; root.style.display='block'; root.querySelector('.modal-backdrop').addEventListener('click', (e)=>{ if(e.target.classList.contains('modal-backdrop')) closeModal(); }); }
function closeModal(){ const root = document.getElementById('modalRoot'); root.innerHTML=''; root.style.display='none'; }
function openSaveExportModal(){ 
    if(!currentFileId) return alert('ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî'); 
    saveCurrent();
    const html = `<h3>ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Î∞è Ïù∏ÏáÑ</h3> <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px"> <label><input type="checkbox" id="fmt_txt" checked> .txt</label> <label><input type="checkbox" id="fmt_docx"> .docx</label> <label><input type="checkbox" id="fmt_pdf"> .pdf</label> </div> <div style="margin-top:16px;display:flex;gap:8px;justify-content:flex-end"> <button id="printBtn">Ïù∏ÏáÑ</button> <button id="exportOk">ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button> </div>`; 
    openModal(html); 
    document.getElementById('exportOk').onclick = ()=>{ 
        const fmts = []; 
        if(document.getElementById('fmt_txt').checked) fmts.push('txt'); 
        if(document.getElementById('fmt_docx').checked) fmts.push('docx'); 
        if(document.getElementById('fmt_pdf').checked) fmts.push('pdf'); 
        if(fmts.length===0) return alert('ÌïòÎÇò Ïù¥ÏÉÅ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî'); 
        downloadSelectedFormats(fmts); 
        closeModal(); 
    }; 
    document.getElementById('printBtn').onclick = ()=>{ printEditorContent(); closeModal(); }; 
}

// ADDED: Function to apply color from the palette modal
function applyColor(color) {
    doCmd('foreColor', color);
    closeModal();
}

// ADDED: Function to open the new color palette modal
function openColorPaletteModal() {
    if (!enableFormatting) return;
    const colors = [
        '#000000', '#6c757d', '#dc3545', '#fd7e14', 
        '#ffc107', '#28a745', '#007bff', '#6f42c1', 
        '#ffffff', '#adb5bd'
    ];
    let swatches = colors.map(color =>
        `<div onclick="applyColor('${color}')" style="width:30px; height:30px; background-color:${color}; cursor:pointer; border:1px solid #ccc; border-radius:50%;"></div>`
    ).join('');
    const html = `
        <h3>ÏÉâÏÉÅ ÏÑ†ÌÉù</h3>
        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top:10px; justify-content: center;">
            ${swatches}
        </div>
        <div style="margin-top:20px; text-align:right;">
            <button onclick="applyColor('inherit')">Í∏∞Î≥∏Í∞íÏúºÎ°ú</button>
        </div>`;
    openModal(html);
}


function downloadSelectedFormats(fmts) {
  if (!currentFileId) return alert('ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî');
  const file = db.files[currentFileId];
  const fileName = file.name || 'document';
  const contentHtml = file.content || '';
  const contentText = document.getElementById('editor').innerText;

  fmts.forEach(format => {
    switch (format) {
      case 'txt': {
        const blob = new Blob([contentText], { type: 'text/plain;charset=utf-8' });
        saveAs(blob, `${fileName}.txt`);
        break;
      }
      case 'docx': {
        const content = `<!DOCTYPE html><html><head><meta charset="UTF-8"></head><body>${contentHtml}</body></html>`;
        const blob = htmlDocx.asBlob(content);
        saveAs(blob, `${fileName}.docx`);
        break;
      }
      case 'pdf': {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFont('Malgun Gothic', 'normal');

            doc.html(contentHtml, {
                callback: function (doc) {
                    doc.save(`${fileName}.pdf`);
                },
                x: 15,
                y: 15,
                width: 170,
                windowWidth: 650
            });
        } catch (e) {
            console.error("PDF export failed:", e);
            alert("PDF ÎÇ¥Î≥¥ÎÇ¥Í∏∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Î≥µÏû°Ìïú ÏÑúÏãùÏùÄ ÏßÄÏõêÎêòÏßÄ ÏïäÏùÑ Ïàò ÏûàÏäµÎãàÎã§.");
        }
        break;
      }
    }
  });
}

function printEditorContent() { if (!currentFileId) return; const printFrame = document.createElement('iframe'); printFrame.style.display = 'none'; document.body.appendChild(printFrame); const content = db.files[currentFileId].content; const doc = printFrame.contentWindow.document; doc.open(); doc.write(`<html><head><title>${escapeHtml(db.files[currentFileId].name)}</title></head><body>${content}</body></html>`); doc.close(); printFrame.contentWindow.focus(); printFrame.contentWindow.print(); setTimeout(() => { document.body.removeChild(printFrame); }, 200); }
function openMainSettingsModal(){ 
  const html = `
    <h3>ÏÑ§Ï†ï</h3> 
    <div style="display:flex;flex-direction:column;gap:12px;margin-top:10px"> 
      <label style="display:flex; align-items:center; justify-content: space-between;"> 
        <span>Îã§ÌÅ¨Î™®Îìú ÏÇ¨Ïö©</span> 
        <input type="checkbox" id="setting_dark"> 
      </label> 
      <div style="font-size: 11px; color: var(--muted); margin-top: -8px;">
        ÎÖ∏Ìä∏Ìå®ÎìúÏùò ÌÖåÎßàÎ•º ÏßÄÏ†ïÌï©ÎãàÎã§.
      </div>
      <hr style="border:none; border-top:1px solid #eee; margin: 4px 0;"> 
      
      <label style="display:flex; align-items:center; justify-content: space-between;"> 
        <span>ÌÖçÏä§Ìä∏ ÏÑúÏãù ÌÜ†Í∏Ä</span> 
        <input type="checkbox" id="setting_formatting"> 
      </label>
      <div style="font-size: 11px; color: var(--muted); margin-top: -8px;">
        ÌÖçÏä§Ìä∏Ïóê Î∞ëÏ§Ñ, ÏÉâÏÉÅ Îì±ÏùÑ Ï†ÅÏö©ÌïòÎäî ÌÜ†Í∏ÄÏùÑ (ÎπÑ)ÌôúÏÑ±ÌôîÌï©ÎãàÎã§.
      </div>
      
      <label style="display:flex; align-items:center; justify-content: space-between;"> 
        <span>Î∂ôÏó¨ÎÑ£Í∏∞ Ìïú ÏÑúÏãù Ïú†ÏßÄ</span> 
        <input type="checkbox" id="setting_paste_format"> 
      </label>
      <div style="font-size: 11px; color: var(--muted); margin-top: -8px;">
        ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Ï†ÄÏû•Îêú ÌÖçÏä§Ìä∏Ïùò ÏÑúÏãùÏùÑ Ïú†ÏßÄ/Ìï¥Ï†úÌï©ÎãàÎã§.
      </div>
      
      <label style="display:flex; align-items:center; justify-content: space-between;"> 
        <span>Ïä§ÎãàÌé´ Í∏∞Îä•</span> 
        <input type="checkbox" id="setting_snippets"> 
      </label>
      <div style="font-size: 11px; color: var(--muted); margin-top: -8px;">
        Îã®Ï∂ïÌÇ§Î°ú ÌÖçÏä§Ìä∏Î•º ÏûêÎèô Î≥ÄÌôòÌïòÎäî Ïä§ÎãàÌé´ Í∏∞Îä•ÏùÑ (ÎπÑ)ÌôúÏÑ±ÌôîÌï©ÎãàÎã§. (Ïòà: /ÎÇ†Ïßú/)
      </div>
      <label style="display:flex; align-items:center; justify-content: space-between;"> 
        <span>Í≥ÑÏÇ∞Í∏∞ Ïä§ÎãàÌé´</span> 
        <input type="checkbox" id="setting_calculator"> 
      </label>
      <div style="font-size: 11px; color: var(--muted); margin-top: -8px;">
        Í∞ÑÎã®Ìïú ÏÇ¨ÏπôÏó∞ÏÇ∞ÏùÑ ÏàòÌñâÌïòÎäî Ïä§ÎãàÌé´ Í∏∞Îä•ÏùÑ (ÎπÑ)ÌôúÏÑ±ÌôîÌï©ÎãàÎã§. (Ïòà: =9*5=)
      </div>

      <hr style="border:none; border-top:1px solid #eee; margin: 4px 0;"> 
      <div style="font-size: 13px;">Í∞úÎ∞úÏûê: <a href="https://github.com/2000may24th" target="_blank" rel="noopener noreferrer">2000may24th(GitHub)</a></div> 
      <button id="resetAll" style="background-color:#e53e3e; color:white; border:none;">Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî</button> 
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end"> 
        <button id="setting_close">Îã´Í∏∞</button> 
      </div> 
    </div>
  `; 
  openModal(html); 

  document.getElementById('setting_dark').checked = dark; 
  document.getElementById('setting_dark').onchange = (e) => { 
    applyDark(e.target.checked); 
  };
  
  document.getElementById('setting_formatting').checked = enableFormatting;
  document.getElementById('setting_formatting').onchange = (e) => {
    enableFormatting = e.target.checked;
    saveDB();
    updateFormattingToolbar();
  };

  document.getElementById('setting_paste_format').checked = preservePasteFormat;
  document.getElementById('setting_paste_format').onchange = (e) => {
    preservePasteFormat = e.target.checked;
    saveDB();
  };
  
  document.getElementById('setting_snippets').checked = enableSnippets;
  document.getElementById('setting_snippets').onchange = (e) => {
    enableSnippets = e.target.checked;
    saveDB();
  };
  
  document.getElementById('setting_calculator').checked = enableCalculator;
  document.getElementById('setting_calculator').onchange = (e) => {
    enableCalculator = e.target.checked;
    saveDB();
  };
  
  document.getElementById('resetAll').onclick = resetAllData; 
  document.getElementById('setting_close').onclick = closeModal; 
}

function openSnippetModal(){ 
  const html = `
    <h3>Ïä§ÎãàÌé´ Í¥ÄÎ¶¨</h3>
    <div class="modal-tab-container">
      <button id="preset-tab-btn" class="modal-tab-button active">ÌîÑÎ¶¨ÏÖã</button>
      <button id="custom-tab-btn" class="modal-tab-button">Ïª§Ïä§ÌÖÄ</button>
    </div>
    
    <div id="preset-snippets-tab" class="tab-content active">
      <h4>Í∏∞Î≥∏ Ï†úÍ≥µ Ïä§ÎãàÌé´</h4>
      <div id="preset-snippets-list" class="snippet-list"></div>
    </div>

    <div id="custom-snippets-tab" class="tab-content">
      <h4>ÏÇ¨Ïö©Ïûê ÏßÄÏ†ï Ïä§ÎãàÌé´</h4>
      <div id="user-snippets-list" class="snippet-list"></div>
      <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 10px; padding: 6px; border: 1px dashed #ddd; border-radius: 4px;">
        <input type="text" id="new-snippet-trigger" placeholder="ÌÇ§ (Ïòà: /hello/)">
        <input type="text" id="new-snippet-value" placeholder="Í∞í (Ïòà: ÏïàÎÖïÌïòÏÑ∏Ïöî)">
        <button id="add-snippet-btn">Ï∂îÍ∞Ä</button>
      </div>
    </div>
    
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end"> 
      <button id="snippet_close">Îã´Í∏∞</button> 
    </div> 
  `;
  openModal(html);
  
  document.getElementById('preset-tab-btn').addEventListener('click', () => switchTab('preset'));
  document.getElementById('custom-tab-btn').addEventListener('click', () => switchTab('custom'));
  
  document.getElementById('snippet_close').onclick = closeModal;
  
  function switchTab(tabId) {
    document.querySelectorAll('.modal-tab-button').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    document.getElementById(tabId + '-tab-btn').classList.add('active');
    document.getElementById(tabId + '-snippets-tab').classList.add('active');
  }

  renderPresetSnippets();
  renderUserSnippets();
  
  document.getElementById('add-snippet-btn').onclick = () => {
    const trigger = document.getElementById('new-snippet-trigger').value.trim();
    const value = document.getElementById('new-snippet-value').value.trim();
    
    if (!trigger.startsWith('/') || !trigger.endsWith('/')) {
        alert('Ïä§ÎãàÌé´ ÌÇ§Îäî Î∞òÎìúÏãú /Î°ú ÏãúÏûëÌïòÍ≥† /Î°ú ÎÅùÎÇòÏïº Ìï©ÎãàÎã§. (Ïòà: /hello/)');
        return;
    }

    if (/\d/.test(trigger)) {
      alert('ÏÇ¨Ïö©Ïûê ÏßÄÏ†ï Ïä§ÎãàÌé´ ÌÇ§ÏóêÎäî Ïà´ÏûêÎ•º Ìè¨Ìï®Ìï† Ïàò ÏóÜÏäµÎãàÎã§.');
      return;
    }

    if (trigger && value) {
      userSnippets.push({ trigger, value, enabled: true });
      document.getElementById('new-snippet-trigger').value = '';
      document.getElementById('new-snippet-value').value = '';
      saveDB();
      renderUserSnippets();
    }
  };

  function renderPresetSnippets() {
    const list = document.getElementById('preset-snippets-list');
    list.innerHTML = '';
    
    Object.keys(presetSnippets).forEach(key => {
      const snippet = presetSnippets[key];
      const item = document.createElement('div');
      item.className = 'snippet-item-grid';
      item.innerHTML = `
        <div class="snippet-key">${escapeHtml(snippet.keys.join(', '))}</div>
        <div class="snippet-desc">${escapeHtml(snippet.desc)}</div>
        <input type="checkbox" data-trigger="${key}" ${snippet.enabled ? 'checked' : ''}>
      `;
      item.querySelector('input[type="checkbox"]').addEventListener('change', (e) => {
        snippet.enabled = e.target.checked;
        saveDB();
      });
      list.appendChild(item);
    });
  }

  function renderUserSnippets() {
    const list = document.getElementById('user-snippets-list');
    list.innerHTML = '';
    userSnippets.forEach((snippet, index) => {
      const item = document.createElement('div');
      item.className = 'snippet-item-grid';
      item.innerHTML = `
        <div class="snippet-key">${escapeHtml(snippet.trigger)}</div>
        <div class="snippet-desc">${escapeHtml(snippet.value)}</div>
        <div class="snippet-actions">
          <input type="checkbox" data-index="${index}" ${snippet.enabled ? 'checked' : ''}>
          <button data-index="${index}" class="delete-snippet-btn">ÏÇ≠Ï†ú</button>
        </div>
      `;
      item.querySelector('input[type="checkbox"]').addEventListener('change', (e) => {
        userSnippets[index].enabled = e.target.checked;
        saveDB();
      });
      item.querySelector('.delete-snippet-btn').addEventListener('click', () => {
        userSnippets.splice(index, 1);
        saveDB();
        renderUserSnippets();
      });
      list.appendChild(item);
    });
  }
}

function resetAllData() { if (confirm('Ï†ïÎßêÎ°ú Î™®Îì† ÌååÏùºÍ≥º Ìè¥ÎçîÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÏù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.')) { db = {folders: {}, files: {}, order: [], folderOrder: []}; saveDB(); currentFileId = null; document.getElementById('editor').innerHTML = ''; document.getElementById('fileNameDisplay').textContent = ''; render(); updateStats(); closeModal(); alert('Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.'); }}
function openFindReplaceModal() { if (!currentFileId) return alert('ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî'); const html = `<h3>Ï∞æÍ∏∞/Î∞îÍæ∏Í∏∞</h3><div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;"><input type="text" id="find-query" placeholder="Ï∞æÏùÑ ÎÇ¥Ïö©" style="width: 100%;"><input type="text" id="replace-query" placeholder="Î∞îÍøÄ ÎÇ¥Ïö©" style="width: 100%;"></div><div style="margin-top: 12px; display: flex; gap: 8px; justify-content: flex-end;"><button id="find-btn">Ï∞æÍ∏∞</button><button id="replace-btn">Î∞îÍæ∏Í∏∞</button><button id="replace-all-btn">Î™®Îëê Î∞îÍæ∏Í∏∞</button><button id="find-close-btn">Îã´Í∏∞</button></div>`; openModal(html); const findInput = document.getElementById('find-query'); const replaceInput = document.getElementById('replace-query'); document.getElementById('find-btn').onclick = () => { const query = findInput.value; if (query && !window.find(query, false, false, true, false, true, false)) { alert('Îçî Ïù¥ÏÉÅ Ï∞æÎäî ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.'); } }; document.getElementById('replace-btn').onclick = () => { const selection = window.getSelection(); if (selection.rangeCount > 0) { document.execCommand('insertText', false, replaceInput.value); } }; document.getElementById('replace-all-btn').onclick = () => { const findQuery = findInput.value; const replaceQuery = replaceInput.value; if (!findQuery) return; const editor = document.getElementById('editor'); let content = editor.innerHTML; const originalContent = content; content = content.replaceAll(findQuery, replaceQuery); if (originalContent !== content) { editor.innerHTML = content; saveCurrent(); alert('Î™®Îì† Ìï≠Î™©ÏùÑ Î∞îÍø®ÏäµÎãàÎã§.'); }}; document.getElementById('find-close-btn').onclick = closeModal; }

function updateFormattingToolbar() {
  const toolbar = document.getElementById('formattingToolbar');
  if (enableFormatting) {
    toolbar.classList.add('active');
  } else {
    toolbar.classList.remove('active');
  }
}
</script>
</body>
</html>

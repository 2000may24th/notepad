<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Static Web Notepad</title>
  <!-- Libraries (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/html-docx-js@0.4.1/dist/html-docx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.3/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>

  <style>
    :root{--bg:#f7f8fb;--card:#fff;--muted:#666;--sidebar:#f8fafc;--accent:#0b66ff}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:#111}

    /* layout */
    .app{display:grid;grid-template-columns:300px 1fr;grid-template-rows:1fr auto;height:100vh}

    /* sidebar */
    nav{background:var(--sidebar);border-right:1px solid #e6e9ef;padding:12px;overflow:auto;transition:transform .25s ease,width .25s}
    nav.hidden{transform:translateX(-100%)}
    header{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    header h2{margin:0;font-size:16px}

    .controls{display:flex;gap:6px;flex-wrap:wrap}
    button,select,input[type=text]{background:#fff;border:1px solid #ddd;padding:6px 8px;border-radius:6px;cursor:pointer}
    button.small{padding:6px}
    .list{margin-top:8px}
    .section-title{font-size:12px;color:var(--muted);margin:10px 0 6px}

    .folder, .file-item{padding:8px;border-radius:6px;margin-bottom:6px;display:flex;align-items:center;justify-content:space-between}
    .folder{background:linear-gradient(90deg,#fdfdfd,#fbfcff);border:1px solid #eee}
    .file-item{background:#fff;border:1px solid #f0f3f7}
    .file-item.draggable{cursor:grab}
    .file-item .meta{flex:1;overflow:hidden}
    .file-item .meta .name{font-weight:600;white-space:nowrap;text-overflow:ellipsis;overflow:hidden}
    .file-item .meta .sub{font-size:12px;color:var(--muted)}
    .file-item .actions{display:flex;gap:6px;margin-left:8px}

    /* editor area */
    main{display:flex;flex-direction:column;gap:8px;padding:12px}
    .toolbar{display:flex;gap:6px;align-items:center}
    .toolbar .group{display:flex;gap:6px;align-items:center;background:var(--card);padding:6px;border-radius:8px;border:1px solid #e9edf3}
    #editor{flex:1;background:var(--card);border:1px solid #e6e9ef;padding:16px;border-radius:8px;overflow:auto}
    #editor[contenteditable="true"]:focus{outline:3px solid rgba(100,150,250,0.12)}

    .top-right-actions{margin-left:auto;display:flex;gap:8px;align-items:center}
    .btn-action{padding:6px 8px;border-radius:6px}

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:200}
    .modal{background:var(--card);padding:16px;border-radius:8px;width:320px;box-shadow:0 6px 32px rgba(0,0,0,0.15)}

    footer{grid-column:1 / -1;background:transparent;padding:8px 12px;border-top:1px solid #e9edf3;display:flex;justify-content:space-between;align-items:center}
    .github-icon{width:20px;height:20px;vertical-align:middle}

    /* drag target highlight */
    .drop-target{outline:2px dashed rgba(11,102,255,0.12)}

    /* tree */
    .folder-children{margin-left:12px;margin-top:6px}

    /* dark mode (not pure black) */
    :root.dark{--bg:#2b2b2b;--card:#393939;--muted:#bfc4c8;--sidebar:#333437;--accent:#9fb8ff}
    body.dark{background:var(--bg);color:#efefef}
    body.dark nav{background:var(--sidebar);border-color:#4a4a4a}
    body.dark .file-item, body.dark .folder{background:var(--card);border-color:#4a4a4a}
    body.dark button{background:#5a5a5a;color:#eee;border-color:#666}

    /* expand handle when sidebar hidden */
    #expandHandle{position:fixed;left:8px;top:16px;width:36px;height:36px;border-radius:6px;background:var(--card);border:1px solid #ddd;display:none;align-items:center;justify-content:center;z-index:300;cursor:pointer}
    nav.hidden + #expandHandle{display:flex}

    /* responsive */
    @media (max-width:800px){.app{grid-template-columns:1fr;grid-template-rows:auto 1fr auto}nav{order:2;height:220px;overflow:auto}.editor-wrap{order:1}}
  </style>
</head>
<body id="bodyRoot">
  <div class="app">
    <nav id="sidebar">
      <header>
        <h2>Web Notepad</h2>
        <div style="margin-left:auto;display:flex;gap:6px;align-items:center">
          <button class="small" id="toggleSidebarBtn" title="사이드바 숨기기">⬅</button>
          <button class="small" id="btnNewFile">+ 파일</button>
          <button class="small" id="btnNewFolder">+ 폴더</button>
        </div>
      </header>

      <div class="controls">
        <input id="search" type="text" placeholder="검색 (파일명/내용)" style="flex:1">
        <select id="filter"><option value="all">전체</option><option value="star">북마크</option></select>
      </div>

      <div class="list">
        <div class="section-title">폴더</div>
        <div id="folders" ondragover="allowDrop(event)"></div>

        <div class="section-title">파일</div>
        <div id="files" ondragover="allowDrop(event)"></div>
      </div>

      <div style="margin-top:12px">
        <div class="section-title">임포트</div>
        <input id="fileInput" type="file" multiple accept=".txt,.md,.html,.docx,.pdf" />
        <div style="margin-top:6px;font-size:12px;color:var(--muted)">여러 파일 선택 가능 • .txt/.docx/.pdf 지원</div>

        <div class="section-title" style="margin-top:12px">병합 / 관리</div>
        <button id="btnMerge">선택 파일 병합</button>
        <button id="btnDeleteSelected">선택 삭제</button>
      </div>
    </nav>

    <div id="expandHandle" title="사이드바 펼치기">➡</div>

    <main class="editor-wrap">
      <div class="toolbar">
        <div class="group">
          <button onclick="doCmd('bold')"><b>B</b></button>
          <button onclick="doCmd('italic')"><i>I</i></button>
          <button onclick="doCmd('underline')"><u>U</u></button>
          <button onclick="doCmd('strikeThrough')">S</button>
          <input type="color" id="colorPick" title="색상" onchange="doCmd('foreColor', this.value)">
          <select id="fontSize" onchange="doCmd('fontSize', this.value)"><option value="3">기본</option><option value="4">크게</option><option value="5">더 크게</option></select>
        </div>

        <div class="group">
          <button id="btnSaveExport" class="btn-action">저장 / 내보내기</button>
          <label style="display:inline-flex;align-items:center;gap:6px;font-size:13px"><input type="checkbox" id="autoSave"> 자동저장</label>
        </div>

        <div class="top-right-actions">
          <input id="fileNameInput" type="text" placeholder="파일 이름" style="min-width:200px;padding:6px;border-radius:6px;border:1px solid #ddd;">
          <button id="btnActions" class="btn-action">작업 ▾</button>
          <button id="btnMergeUI">병합 UI</button>
          <button id="btnSettings">⚙ 환경설정</button>
        </div>
      </div>

      <div id="editor" contenteditable="true" spellcheck="false"></div>

    </main>

    <footer style="display:none">
      <div>만든이: <a class="github" href="https://github.com/2000may24th" target="_blank"><img class="github-icon" src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="github"></a></div>
      <div style="font-size:12px;color:var(--muted)">로컬 저장 • 정적 페이지 (Github Pages)에서 동작</div>
    </footer>
  </div>

  <!-- Modals -->
  <div id="modalRoot" style="display:none"></div>

<script>
// --- 데이터 model (localStorage 기반) ---
const DB_KEY = 'web_notepad_v1';
let db = {folders: {}, files: {}, order: []};
let selectedFiles = new Set();
let currentFileId = null;

function loadDB(){
  const raw = localStorage.getItem(DB_KEY);
  if(raw) try{db = JSON.parse(raw)}catch(e){console.error(e)}
}
function saveDB(){
  localStorage.setItem(DB_KEY, JSON.stringify(db));
}

function uid(prefix='f'){return prefix+Date.now().toString(36)+Math.random().toString(36).slice(2,8)}

// --- initial ---
loadDB();
if(Object.keys(db.files).length===0){
  const id = uid(); db.files[id] = {id,name:'새 문서',content:'',folder:null,star:false,created:Date.now(),updated:Date.now()}; db.order.push(id); saveDB();}

// --- drag helpers ---
let dragId = null; // id of file or folder being dragged
let dragType = null; // 'file' or 'folder'

function allowDrop(e){ e.preventDefault(); }

function onDragStart(ev, id, type){ dragId = id; dragType = type; ev.dataTransfer.setData('text/plain', id); ev.dataTransfer.effectAllowed = 'move'; }

function onFilesDrop(ev){ ev.preventDefault(); const targetId = ev.target.closest('.file-item')?.dataset?.id || null; // drop to reorder before targetId
  if(dragType === 'file' && dragId){ reorderFile(dragId, targetId); dragId=null; render(); }
}

function onFolderDrop(ev){ ev.preventDefault(); const folderEl = ev.target.closest('.folder'); if(!folderEl || !dragId) return; const folderId = folderEl.dataset.id; if(dragType==='file'){ db.files[dragId].folder = folderId; db.files[dragId].updated = Date.now(); saveDB(); render(); } dragId=null; }

// reorder file in db.order: move dragId before targetId (if targetId null, push to end)
function reorderFile(dragIdLocal, targetId){
  const idx = db.order.indexOf(dragIdLocal); if(idx>-1) db.order.splice(idx,1);
  if(targetId && db.order.indexOf(targetId)!==-1){ const ti = db.order.indexOf(targetId); db.order.splice(ti,0,dragIdLocal); } else { db.order.push(dragIdLocal); }
  saveDB();
}

// reorder folder (simple approach: keep folder ids in array sorted by created time -> we'll store folderOrder)
if(!db.folderOrder) db.folderOrder = Object.keys(db.folders);
function reorderFolder(dragIdLocal, targetId){ const arr = db.folderOrder||[]; const idx = arr.indexOf(dragIdLocal); if(idx>-1) arr.splice(idx,1); if(targetId && arr.indexOf(targetId)!==-1){ const ti = arr.indexOf(targetId); arr.splice(ti,0,dragIdLocal); } else arr.push(dragIdLocal); db.folderOrder = arr; saveDB(); }

// --- render ---
function render(){
  renderFolders();
  renderFiles();
  renderMoveList();
}

function renderFolders(){
  const cont = document.getElementById('folders'); cont.innerHTML='';
  const order = db.folderOrder && db.folderOrder.length?db.folderOrder:Object.keys(db.folders);
  order.forEach(fid=>{ const f = db.folders[fid]; if(!f) return; const el = document.createElement('div'); el.className='folder'; el.draggable = true; el.dataset.id = f.id; el.innerHTML = `<div style="flex:1;display:flex;align-items:center;gap:8px"><button onclick="toggleFolder('${f.id}')">▸</button><div style=\"flex:1;cursor:pointer\" onclick=\"openFolder('${f.id}')\">📁 ${escapeHtml(f.name)}</div></div><div style="display:flex;gap:6px"><button onclick="renameFolder('${f.id}')">✏️</button><button onclick="deleteFolder('${f.id}')">🗑️</button></div>`;
    el.ondragstart = (ev)=>onDragStart(ev, f.id, 'folder');
    el.ondragover = (ev)=>{ ev.preventDefault(); el.classList.add('drop-target'); };
    el.ondragleave = ()=>{ el.classList.remove('drop-target'); };
    el.ondrop = (ev)=>{ el.classList.remove('drop-target'); onFolderDrop(ev); if(dragType==='folder') { reorderFolder(dragId, f.id); dragId=null; render(); } };
    // children container
    const children = document.createElement('div'); children.className = 'folder-children'; children.id = 'children-'+f.id; children.style.display = f._open? 'block':'none';
    // render files in this folder
    Object.values(db.files).forEach(file=>{ if(file.folder===f.id){ const fi = document.createElement('div'); fi.className='file-item draggable'; fi.dataset.id = file.id; fi.innerHTML = `<div class="meta"><div class="name">${escapeHtml(file.name)}</div><div class="sub">${new Date(file.updated).toLocaleString()}</div></div><div class="actions"><input type="checkbox" onchange="toggleSelect(event,'${file.id}')" ${selectedFiles.has(file.id)?'checked':''}></div>`; fi.onclick = ()=>openFile(file.id); fi.draggable=true; fi.ondragstart=(ev)=>onDragStart(ev,file.id,'file'); fi.ondragover=(ev)=>{ev.preventDefault(); fi.classList.add('drop-target')}; fi.ondragleave=()=>fi.classList.remove('drop-target'); fi.ondrop=(ev)=>{fi.classList.remove('drop-target'); if(dragType==='file'){ reorderFile(dragId,file.id); dragId=null; render(); }}; children.appendChild(fi); }});
    cont.appendChild(el); cont.appendChild(children);
  })
}

function renderFiles(){
  const cont = document.getElementById('files'); cont.innerHTML='';
  const q = document.getElementById('search').value.toLowerCase();
  const filter = document.getElementById('filter').value;
  db.order.forEach(id=>{
    const f = db.files[id];
    if(!f) return;
    // only show files not in folder here
    if(f.folder) return;
    if(filter==='star' && !f.star) return;
    if(q){if(!(f.name.toLowerCase().includes(q) || stripTags(f.content).toLowerCase().includes(q))) return}
    const div = document.createElement('div'); div.className='file-item draggable'; div.dataset.id = f.id;
    div.innerHTML = `<div class="meta"><div class="name">${escapeHtml(f.name)}</div><div class="sub">${new Date(f.updated).toLocaleString()}</div></div>
      <div class="actions"><input type="checkbox" onchange="toggleSelect(event,'${f.id}')" ${selectedFiles.has(f.id)?'checked':''}></div>`;
    // click to open
    div.onclick = ()=>openFile(f.id);
    // drag handlers
    div.draggable = true;
    div.ondragstart = (ev)=>onDragStart(ev, f.id, 'file');
    div.ondragover = (ev)=>{ ev.preventDefault(); div.classList.add('drop-target'); };
    div.ondragleave = ()=>{ div.classList.remove('drop-target'); };
    div.ondrop = (ev)=>{ div.classList.remove('drop-target'); if(dragType==='file'){ reorderFile(dragId, f.id); dragId=null; render(); } };

    cont.appendChild(div);
  })
}

function renderMoveList(){
  const sel = document.getElementById('moveToFolder'); sel.innerHTML='';
  const opt = document.createElement('option'); opt.value='__null'; opt.textContent='루트'; sel.appendChild(opt);
  Object.values(db.folders).forEach(f=>{const o=document.createElement('option');o.value=f.id;o.textContent=f.name;sel.appendChild(o)})
}

// --- helpers ---
function escapeHtml(s){return (s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c])}
function stripTags(html){return html.replace(/<[^>]+>/g,'')}

// --- file ops ---
function newFile(){
  const id=uid(); db.files[id]={id,name:'무제',content:'',folder:null,star:false,created:Date.now(),updated:Date.now()}; db.order.unshift(id); saveDB(); render(); openFile(id);
}
function newFolder(){
  const name = prompt('폴더 이름:'); if(!name) return; const id=uid('d'); db.folders[id]={id,name}; db.folderOrder = db.folderOrder || []; db.folderOrder.unshift(id); saveDB(); render();
}

function toggleFolder(id){ db.folders[id]._open = !db.folders[id]._open; render(); }
function openFolder(id){ db.folders[id]._open = !db.folders[id]._open; render(); }

function renameFolder(id){
  const name = prompt('새 폴더 이름:', db.folders[id].name); if(!name) return; db.folders[id].name=name; saveDB(); render();
}
function deleteFolder(id){
  if(!confirm('폴더와 그 안의 파일들을 삭제하시겠어요?')) return;
  Object.values(db.files).forEach(f=>{if(f.folder===id) delete db.files[f.id];}); delete db.folders[id]; db.folderOrder = (db.folderOrder||[]).filter(x=>x!==id); db.order = db.order.filter(x=>db.files[x]); saveDB(); render();
}

function openFile(id){
  currentFileId = id; const f = db.files[id]; document.getElementById('editor').innerHTML = f.content || '';
  document.getElementById('fileNameInput').value = f.name || '';
}

function renameCurrentFileFromInput(){
  if(!currentFileId) return; const newName = document.getElementById('fileNameInput').value.trim(); if(!newName) return alert('이름을 비울 수 없습니다'); db.files[currentFileId].name = newName; db.files[currentFileId].updated = Date.now(); saveDB(); render(); }

function saveCurrent(){
  if(!currentFileId) return alert('먼저 파일을 선택하세요');
  const content = document.getElementById('editor').innerHTML;
  const f = db.files[currentFileId]; f.content = content; f.updated = Date.now(); if(!f.name || f.name==='무제'){
    const t = stripTags(content).slice(0,30).trim(); if(t) f.name = t;
  }
  saveDB(); render();
}

function deleteFileById(id){
  if(!confirm('파일을 삭제할까요?')) return; delete db.files[id]; db.order = db.order.filter(x=>x!==id); if(currentFileId===id){ currentFileId=null; document.getElementById('editor').innerHTML=''; document.getElementById('fileNameInput').value=''; } saveDB(); render();
}
function deleteCurrentFile(){ if(!currentFileId) return alert('파일 선택'); deleteFileById(currentFileId); }

function toggleSelect(ev,id){ if(ev.target.checked) selectedFiles.add(id); else selectedFiles.delete(id); }

function toggleStar(id){ db.files[id].star = !db.files[id].star; saveDB(); render(); }

function downloadTxt(id){ const f=db.files[id]; const blob=new Blob([stripTags(f.content)],{type:'text/plain;charset=utf-8'}); saveAs(blob, (f.name||'untitled')+'.txt'); }
function downloadDocx(id){ const f = db.files[id]; const html = `<html><body>${f.content||''}</body></html>`; try{ const converted = window.htmlDocx.asBlob(html); saveAs(converted, (f.name||'document') + '.docx'); }catch(e){alert('DOCX 생성 실패: '+e.message)} }
function downloadPdf(id){ const f=db.files[id]; const { jsPDF } = window.jspdf; const doc = new jsPDF(); const text = stripTags(f.content); const lines = doc.splitTextToSize(text, 180); doc.text(lines,10,10); const blob = doc.output('blob'); saveAs(blob, (f.name||'doc') + '.pdf'); }

function downloadSelectedFormats(formats){ if(!currentFileId) return alert('파일을 선택하세요'); formats.forEach(fmt=>{ if(fmt==='txt') downloadTxt(currentFileId); if(fmt==='docx') downloadDocx(currentFileId); if(fmt==='pdf') downloadPdf(currentFileId); }); }

// --- import ---
const fileInput = document.getElementById('fileInput'); fileInput.addEventListener('change', async e=>{
  const filesList = Array.from(e.target.files);
  for(const file of filesList){
    const name = prompt(`불러올 파일의 이름 (파일: ${file.name})`, file.name.replace(/\.[^.]+$/,''));
    if(!name) continue;
    try{
      if(file.name.endsWith('.txt')||file.type.includes('text')){
        const txt = await file.text(); const id=uid(); db.files[id]={id,name,content:escapeHtml(txt).replace(/\n/g,'<br>'),folder:null,star:false,created:Date.now(),updated:Date.now()}; db.order.unshift(id);
      } else if(file.name.endsWith('.docx')){
        const arr = await file.arrayBuffer(); const id=uid(); db.files[id]={id,name,content:`(DOCX 파일 — 원본이 첨부됨)`,raw:{type:'docx',data:arrayBufferToBase64(arr)},folder:null,star:false,created:Date.now(),updated:Date.now()}; db.order.unshift(id);
      } else if(file.name.endsWith('.pdf')){
        const arr = await file.arrayBuffer(); const id=uid(); db.files[id]={id,name,content:`(PDF 파일 — 미리보기 없음)`,raw:{type:'pdf',data:arrayBufferToBase64(arr)},folder:null,star:false,created:Date.now(),updated:Date.now()}; db.order.unshift(id);
      } else {
        const txt = await file.text(); const id=uid(); db.files[id]={id,name,content:escapeHtml(txt).replace(/\n/g,'<br>'),folder:null,star:false,created:Date.now(),updated:Date.now()}; db.order.unshift(id);
      }
    } catch(err){console.error(err)}
  }
  saveDB(); render(); fileInput.value='';
});

function arrayBufferToBase64(buffer){ let binary=''; const bytes = new Uint8Array(buffer); const len = bytes.byteLength; for(let i=0;i<len;i++){binary+=String.fromCharCode(bytes[i]);} return btoa(binary); }

// --- merge selected ---
function mergeSelected(){ if(selectedFiles.size<2) return alert('두 개 이상의 파일을 선택하세요');
  const ids = Array.from(selectedFiles); let merged=''; let name='병합문서'; ids.forEach(id=>{const f=db.files[id]; merged += `<h3>${escapeHtml(f.name)}</h3>` + (f.content||'') + '<hr>';});
  const id = uid(); db.files[id]={id,name: name,content:merged,folder:null,star:false,created:Date.now(),updated:Date.now()}; db.order.unshift(id); saveDB(); render(); openFile(id); selectedFiles.clear();
}

// --- delete selected ---
function deleteSelected(){ if(selectedFiles.size===0) return alert('선택된 파일이 없습니다'); if(!confirm('선택된 파일을 삭제할까요?')) return; selectedFiles.forEach(id=>{delete db.files[id]; db.order = db.order.filter(x=>x!==id)}); saveDB(); render(); selectedFiles.clear(); }

// --- move ---
function moveSelected(){ if(selectedFiles.size===0) return alert('선택된 파일이 없습니다'); const to = document.getElementById('moveToFolder').value; selectedFiles.forEach(id=>{db.files[id].folder = (to==='__null'?null:to); db.files[id].updated = Date.now()}); saveDB(); render(); selectedFiles.clear(); }

// --- UI bindings ---
document.getElementById('btnNewFile').onclick = newFile;
document.getElementById('btnNewFolder').onclick = newFolder;
document.getElementById('search').addEventListener('input', render);
document.getElementById('filter').addEventListener('change', render);
document.getElementById('btnSaveExport').onclick = ()=>{ openSaveExportModal(); };
document.getElementById('btnMerge').onclick = mergeSelected;
document.getElementById('btnDeleteSelected').onclick = deleteSelected;

// actions menu
const btnActions = document.getElementById('btnActions'); btnActions.addEventListener('click', ()=>{ openActionsMenu(); });

// move
const btnMove = document.getElementById('btnMove'); const selMove = document.getElementById('moveToFolder');
btnMove && (btnMove.onclick = ()=>{ if(selMove.style.display==='none'){selMove.style.display='inline-block'; btnMove.textContent='이동(확인)';} else {moveSelected(); selMove.style.display='none'; btnMove.textContent='이동';}})

// star
document.getElementById('btnStar')?.addEventListener('click', ()=>{ if(!currentFileId) return alert('파일 선택'); toggleStar(currentFileId); });

// merge UI quick
let mergeMode=false; document.getElementById('btnMergeUI').onclick = ()=>{mergeMode=!mergeMode; alert('병합 UI ' + (mergeMode?'활성화':'비활성화') + '. 좌측에서 파일을 체크한 뒤 "선택 파일 병합" 클릭')}

// autosave
const autoSaveCb = document.getElementById('autoSave'); autoSaveCb.addEventListener('change', ()=>{ if(autoSaveCb.checked) startAutoSave(); else stopAutoSave();}); let autoSaveTimer=null;
function startAutoSave(){ if(autoSaveTimer) clearInterval(autoSaveTimer); autoSaveTimer = setInterval(()=>{ if(currentFileId) saveCurrent(); }, 3000);} function stopAutoSave(){ if(autoSaveTimer) clearInterval(autoSaveTimer); autoSaveTimer=null}

// keyboard shortcuts
document.addEventListener('keydown', e=>{
  if((e.ctrlKey||e.metaKey) && e.key==='s'){ e.preventDefault(); saveCurrent(); alert('저장됨'); }
  if((e.ctrlKey||e.metaKey) && e.key==='b'){ e.preventDefault(); doCmd('bold'); }
});

// editor change to update file name preview
document.getElementById('editor').addEventListener('input', ()=>{ if(currentFileId){ db.files[currentFileId].updated=Date.now(); }});

// fileName input rename
const fileNameInput = document.getElementById('fileNameInput'); fileNameInput.addEventListener('change', renameCurrentFileFromInput);

// sidebar toggle
const toggleSidebarBtn = document.getElementById('toggleSidebarBtn'); const expandHandle = document.getElementById('expandHandle');
toggleSidebarBtn.addEventListener('click', ()=>{ document.getElementById('sidebar').classList.toggle('hidden'); toggleSidebarBtn.textContent = document.getElementById('sidebar').classList.contains('hidden') ? '➡' : '⬅'; });
expandHandle.addEventListener('click', ()=>{ document.getElementById('sidebar').classList.remove('hidden'); toggleSidebarBtn.textContent='⬅'; });

// settings modal
const btnSettings = document.getElementById('btnSettings'); btnSettings.addEventListener('click', ()=>{ openSettingsModal(); });

// helper: command
function doCmd(cmd, val=null){ document.execCommand(cmd, false, val); }

// toggle dark
let dark=false; function applyDark(d){ dark = !!d; document.documentElement.classList.toggle('dark', dark); document.body.classList.toggle('dark', dark); localStorage.setItem('wn_dark', dark? '1':'0'); }
// load saved theme
if(localStorage.getItem('wn_dark')==='1') applyDark(true);

// download whole database
function exportAll(){ const blob = new Blob([JSON.stringify(db, null, 2)],{type:'application/json'}); saveAs(blob, 'web-notes-backup.json'); }

// import backup
async function importBackupFile(file){ const txt = await file.text(); try{ db = JSON.parse(txt); saveDB(); render(); alert('백업 복원됨'); }catch(e){alert('복원실패') } }

// utility: open first file
if(db.order.length) openFile(db.order[0]);
render();

// expose some functions for inline buttons
window.newFile=newFile; window.newFolder=newFolder; window.openFile=openFile; window.deleteFile=deleteFileById; window.toggleStar=toggleStar; window.toggleSelect=toggleSelect; window.downloadTxt=downloadTxt; window.mergeSelected=mergeSelected; window.deleteSelected=deleteSelected; window.exportDocx=downloadDocx; window.exportPdf=downloadPdf; window.saveCurrent=saveCurrent; window.render=render; window.saveDB=saveDB;

// --- UI modal implementations ---
function openModal(contentHtml){ const root = document.getElementById('modalRoot'); root.innerHTML = `<div class="modal-backdrop"> <div class="modal">${contentHtml}</div> </div>`; root.style.display='block'; root.querySelector('.modal-backdrop').addEventListener('click', (e)=>{ if(e.target.classList.contains('modal-backdrop')) closeModal(); }); }
function closeModal(){ const root = document.getElementById('modalRoot'); root.innerHTML=''; root.style.display='none'; }

function openSaveExportModal(){ if(!currentFileId) return alert('파일을 선택하세요'); const html = `
  <h3>내보내기 형식 선택</h3>
  <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
    <label><input type="checkbox" id="fmt_txt" checked> .txt</label>
    <label><input type="checkbox" id="fmt_docx"> .docx</label>
    <label><input type="checkbox" id="fmt_pdf"> .pdf</label>
  </div>
  <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
    <button id="exportCancel">취소</button>
    <button id="exportOk">내보내기</button>
  </div>
`;
  openModal(html);
  document.getElementById('exportCancel').onclick = closeModal;
  document.getElementById('exportOk').onclick = ()=>{
    const fmts = [];
    if(document.getElementById('fmt_txt').checked) fmts.push('txt');
    if(document.getElementById('fmt_docx').checked) fmts.push('docx');
    if(document.getElementById('fmt_pdf').checked) fmts.push('pdf');
    if(fmts.length===0) return alert('하나 이상 선택하세요');
    saveCurrent(); downloadSelectedFormats(fmts); closeModal();
  };
}

function openActionsMenu(){ if(!currentFileId) return alert('파일을 선택하세요'); const html = `
  <h3>작업</h3>
  <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
    <button id="act_delete">삭제</button>
    <button id="act_toggle_star">북마크 토글</button>
    <div style="display:flex;gap:8px;align-items:center"><select id="act_move_list"></select><button id="act_move_confirm">이동</button></div>
  </div>
  <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
    <button id="act_close">닫기</button>
  </div>
`;
  openModal(html);
  const moveList = document.getElementById('act_move_list'); moveList.innerHTML=''; const opt = document.createElement('option'); opt.value='__null'; opt.textContent='루트'; moveList.appendChild(opt); Object.values(db.folders).forEach(f=>{ const o=document.createElement('option'); o.value=f.id; o.textContent=f.name; moveList.appendChild(o); });
  document.getElementById('act_delete').onclick = ()=>{ if(confirm('파일을 삭제할까요?')){ deleteFileById(currentFileId); closeModal(); } };
  document.getElementById('act_toggle_star').onclick = ()=>{ toggleStar(currentFileId); closeModal(); };
  document.getElementById('act_move_confirm').onclick = ()=>{ const to = moveList.value; db.files[currentFileId].folder = (to==='__null'?null:to); db.files[currentFileId].updated = Date.now(); saveDB(); render(); closeModal(); };
  document.getElementById('act_close').onclick = closeModal;
}

function openSettingsModal(){ const html = `
  <h3>환경설정</h3>
  <div style="display:flex;flex-direction:column;gap:10px;margin-top:10px">
    <label><input type="checkbox" id="setting_dark"> 다크모드 사용</label>
    <div>제작자: <a href="https://github.com/2000may24th" target="_blank">2000may24th (GitHub)</a></div>
    <div style="display:flex;gap:8px;justify-content:flex-end"><button id="setting_close">닫기</button></div>
  </div>
`;
  openModal(html);
  document.getElementById('setting_dark').checked = dark;
  document.getElementById('setting_dark').onchange = (e)=>{ applyDark(e.target.checked); };
  document.getElementById('setting_close').onclick = closeModal;
}

</script>
</body>
</html>

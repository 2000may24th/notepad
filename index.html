<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Static Web Notepad</title>
  <!-- Libraries (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/html-docx-js@0.4.1/dist/html-docx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.3/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>

  <style>
    :root{--bg:#f7f8fb;--card:#fff;--muted:#666;--sidebar:#f8fafc;--accent:#0b66ff}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:#111}

    /* layout */
    .app{display:grid;grid-template-columns:300px 1fr;grid-template-rows:1fr auto;height:100vh}

    /* sidebar */
    nav{background:var(--sidebar);border-right:1px solid #e6e9ef;padding:12px;overflow:auto;transition:transform .25s ease,width .25s}
    nav.hidden{transform:translateX(-100%)}
    header{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    header h2{margin:0;font-size:16px}

    .controls{display:flex;gap:6px;flex-wrap:wrap}
    button,select,input[type=text]{background:#fff;border:1px solid #ddd;padding:6px 8px;border-radius:6px;cursor:pointer}
    button.small{padding:6px}
    .list{margin-top:8px}
    .section-title{font-size:12px;color:var(--muted);margin:10px 0 6px}

    .folder, .file-item{padding:8px;border-radius:6px;margin-bottom:6px;display:flex;align-items:center;justify-content:space-between}
    .folder{background:linear-gradient(90deg,#fdfdfd,#fbfcff);border:1px solid #eee}
    .file-item{background:#fff;border:1px solid #f0f3f7}
    .file-item.draggable{cursor:grab}
    .file-item .meta{flex:1;overflow:hidden}
    .file-item .meta .name{font-weight:600;white-space:nowrap;text-overflow:ellipsis;overflow:hidden}
    .file-item .meta .sub{font-size:12px;color:var(--muted)}
    .file-item .actions{display:flex;gap:6px;margin-left:8px}

    /* editor area */
    main{display:flex;flex-direction:column;gap:8px;padding:12px}
    .toolbar{display:flex;gap:6px;align-items:center}
    .toolbar .group{display:flex;gap:6px;align-items:center;background:var(--card);padding:6px;border-radius:8px;border:1px solid #e9edf3}
    #editor{flex:1;background:var(--card);border:1px solid #e6e9ef;padding:16px;border-radius:8px;overflow:auto}
    #editor[contenteditable="true"]:focus{outline:3px solid rgba(100,150,250,0.12)}

    .top-right-actions{margin-left:auto;display:flex;gap:8px;align-items:center}
    .btn-action{padding:6px 8px;border-radius:6px}

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:200}
    .modal{background:var(--card);padding:16px;border-radius:8px;width:320px;box-shadow:0 6px 32px rgba(0,0,0,0.15)}

    footer{grid-column:1 / -1;background:transparent;padding:8px 12px;border-top:1px solid #e9edf3;display:flex;justify-content:space-between;align-items:center}
    .github-icon{width:20px;height:20px;vertical-align:middle}

    /* drag target highlight */
    .drop-target{outline:2px dashed rgba(11,102,255,0.12)}

    /* tree */
    .folder-children{margin-left:12px;margin-top:6px}

    /* dark mode (not pure black) */
    :root.dark{--bg:#2b2b2b;--card:#393939;--muted:#bfc4c8;--sidebar:#333437;--accent:#9fb8ff}
    body.dark{background:var(--bg);color:#efefef}
    body.dark nav{background:var(--sidebar);border-color:#4a4a4a}
    body.dark .file-item, body.dark .folder{background:var(--card);border-color:#4a4a4a}
    body.dark button{background:#5a5a5a;color:#eee;border-color:#666}

    /* expand handle when sidebar hidden */
    #expandHandle{position:fixed;left:8px;top:16px;width:36px;height:36px;border-radius:6px;background:var(--card);border:1px solid #ddd;display:none;align-items:center;justify-content:center;z-index:300;cursor:pointer}
    nav.hidden + #expandHandle{display:flex}

    /* responsive */
    @media (max-width:800px){.app{grid-template-columns:1fr;grid-template-rows:auto 1fr auto}nav{order:2;height:220px;overflow:auto}.editor-wrap{order:1}}
  </style>
</head>
<body id="bodyRoot">
  <div class="app">
    <nav id="sidebar">
      <header>
        <h2>Web Notepad</h2>
        <div style="margin-left:auto;display:flex;gap:6px;align-items:center">
          <button class="small" id="toggleSidebarBtn" title="ì‚¬ì´ë“œë°” ìˆ¨ê¸°ê¸°">â¬…</button>
          <button class="small" id="btnNewFile">+ íŒŒì¼</button>
          <button class="small" id="btnNewFolder">+ í´ë”</button>
        </div>
      </header>

      <div class="controls">
        <input id="search" type="text" placeholder="ê²€ìƒ‰ (íŒŒì¼ëª…/ë‚´ìš©)" style="flex:1">
        <select id="filter"><option value="all">ì „ì²´</option><option value="star">ë¶ë§ˆí¬</option></select>
      </div>

      <div class="list">
        <div class="section-title">í´ë”</div>
        <div id="folders" ondragover="allowDrop(event)"></div>

        <div class="section-title">íŒŒì¼</div>
        <div id="files" ondragover="allowDrop(event)"></div>
      </div>

      <div style="margin-top:12px">
        <div class="section-title">ì„í¬íŠ¸</div>
        <input id="fileInput" type="file" multiple accept=".txt,.md,.html,.docx,.pdf" />
        <div style="margin-top:6px;font-size:12px;color:var(--muted)">ì—¬ëŸ¬ íŒŒì¼ ì„ íƒ ê°€ëŠ¥ â€¢ .txt/.docx/.pdf ì§€ì›</div>

        <div class="section-title" style="margin-top:12px">ë³‘í•© / ê´€ë¦¬</div>
        <button id="btnMerge">ì„ íƒ íŒŒì¼ ë³‘í•©</button>
        <button id="btnDeleteSelected">ì„ íƒ ì‚­ì œ</button>
      </div>
    </nav>

    <div id="expandHandle" title="ì‚¬ì´ë“œë°” í¼ì¹˜ê¸°">â¡</div>

    <main class="editor-wrap">
      <div class="toolbar">
        <div class="group">
          <button onclick="doCmd('bold')"><b>B</b></button>
          <button onclick="doCmd('italic')"><i>I</i></button>
          <button onclick="doCmd('underline')"><u>U</u></button>
          <button onclick="doCmd('strikeThrough')">S</button>
          <input type="color" id="colorPick" title="ìƒ‰ìƒ" onchange="doCmd('foreColor', this.value)">
          <select id="fontSize" onchange="doCmd('fontSize', this.value)"><option value="3">ê¸°ë³¸</option><option value="4">í¬ê²Œ</option><option value="5">ë” í¬ê²Œ</option></select>
        </div>

        <div class="group">
          <button id="btnSaveExport" class="btn-action">ì €ì¥ / ë‚´ë³´ë‚´ê¸°</button>
          <label style="display:inline-flex;align-items:center;gap:6px;font-size:13px"><input type="checkbox" id="autoSave"> ìë™ì €ì¥</label>
        </div>

        <div class="top-right-actions">
          <input id="fileNameInput" type="text" placeholder="íŒŒì¼ ì´ë¦„" style="min-width:200px;padding:6px;border-radius:6px;border:1px solid #ddd;">
          <button id="btnActions" class="btn-action">ì‘ì—… â–¾</button>
          <button id="btnMergeUI">ë³‘í•© UI</button>
          <button id="btnSettings">âš™ í™˜ê²½ì„¤ì •</button>
        </div>
      </div>

      <div id="editor" contenteditable="true" spellcheck="false"></div>

    </main>

    <footer style="display:none">
      <div>ë§Œë“ ì´: <a class="github" href="https://github.com/2000may24th" target="_blank"><img class="github-icon" src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="github"></a></div>
      <div style="font-size:12px;color:var(--muted)">ë¡œì»¬ ì €ì¥ â€¢ ì •ì  í˜ì´ì§€ (Github Pages)ì—ì„œ ë™ì‘</div>
    </footer>
  </div>

  <!-- Modals -->
  <div id="modalRoot" style="display:none"></div>

<script>
// --- ë°ì´í„° model (localStorage ê¸°ë°˜) ---
const DB_KEY = 'web_notepad_v1';
let db = {folders: {}, files: {}, order: []};
let selectedFiles = new Set();
let currentFileId = null;

function loadDB(){
  const raw = localStorage.getItem(DB_KEY);
  if(raw) try{db = JSON.parse(raw)}catch(e){console.error(e)}
}
function saveDB(){
  localStorage.setItem(DB_KEY, JSON.stringify(db));
}

function uid(prefix='f'){return prefix+Date.now().toString(36)+Math.random().toString(36).slice(2,8)}

// --- initial ---
loadDB();
if(Object.keys(db.files).length===0){
  const id = uid(); db.files[id] = {id,name:'ìƒˆ ë¬¸ì„œ',content:'',folder:null,star:false,created:Date.now(),updated:Date.now()}; db.order.push(id); saveDB();}

// --- drag helpers ---
let dragId = null; // id of file or folder being dragged
let dragType = null; // 'file' or 'folder'

function allowDrop(e){ e.preventDefault(); }

function onDragStart(ev, id, type){ dragId = id; dragType = type; ev.dataTransfer.setData('text/plain', id); ev.dataTransfer.effectAllowed = 'move'; }

function onFilesDrop(ev){ ev.preventDefault(); const targetId = ev.target.closest('.file-item')?.dataset?.id || null; // drop to reorder before targetId
  if(dragType === 'file' && dragId){ reorderFile(dragId, targetId); dragId=null; render(); }
}

function onFolderDrop(ev){ ev.preventDefault(); const folderEl = ev.target.closest('.folder'); if(!folderEl || !dragId) return; const folderId = folderEl.dataset.id; if(dragType==='file'){ db.files[dragId].folder = folderId; db.files[dragId].updated = Date.now(); saveDB(); render(); } dragId=null; }

// reorder file in db.order: move dragId before targetId (if targetId null, push to end)
function reorderFile(dragIdLocal, targetId){
  const idx = db.order.indexOf(dragIdLocal); if(idx>-1) db.order.splice(idx,1);
  if(targetId && db.order.indexOf(targetId)!==-1){ const ti = db.order.indexOf(targetId); db.order.splice(ti,0,dragIdLocal); } else { db.order.push(dragIdLocal); }
  saveDB();
}

// reorder folder (simple approach: keep folder ids in array sorted by created time -> we'll store folderOrder)
if(!db.folderOrder) db.folderOrder = Object.keys(db.folders);
function reorderFolder(dragIdLocal, targetId){ const arr = db.folderOrder||[]; const idx = arr.indexOf(dragIdLocal); if(idx>-1) arr.splice(idx,1); if(targetId && arr.indexOf(targetId)!==-1){ const ti = arr.indexOf(targetId); arr.splice(ti,0,dragIdLocal); } else arr.push(dragIdLocal); db.folderOrder = arr; saveDB(); }

// --- render ---
function render(){
  renderFolders();
  renderFiles();
  renderMoveList();
}

function renderFolders(){
  const cont = document.getElementById('folders'); cont.innerHTML='';
  const order = db.folderOrder && db.folderOrder.length?db.folderOrder:Object.keys(db.folders);
  order.forEach(fid=>{ const f = db.folders[fid]; if(!f) return; const el = document.createElement('div'); el.className='folder'; el.draggable = true; el.dataset.id = f.id; el.innerHTML = `<div style="flex:1;display:flex;align-items:center;gap:8px"><button onclick="toggleFolder('${f.id}')">â–¸</button><div style=\"flex:1;cursor:pointer\" onclick=\"openFolder('${f.id}')\">ğŸ“ ${escapeHtml(f.name)}</div></div><div style="display:flex;gap:6px"><button onclick="renameFolder('${f.id}')">âœï¸</button><button onclick="deleteFolder('${f.id}')">ğŸ—‘ï¸</button></div>`;
    el.ondragstart = (ev)=>onDragStart(ev, f.id, 'folder');
    el.ondragover = (ev)=>{ ev.preventDefault(); el.classList.add('drop-target'); };
    el.ondragleave = ()=>{ el.classList.remove('drop-target'); };
    el.ondrop = (ev)=>{ el.classList.remove('drop-target'); onFolderDrop(ev); if(dragType==='folder') { reorderFolder(dragId, f.id); dragId=null; render(); } };
    // children container
    const children = document.createElement('div'); children.className = 'folder-children'; children.id = 'children-'+f.id; children.style.display = f._open? 'block':'none';
    // render files in this folder
    Object.values(db.files).forEach(file=>{ if(file.folder===f.id){ const fi = document.createElement('div'); fi.className='file-item draggable'; fi.dataset.id = file.id; fi.innerHTML = `<div class="meta"><div class="name">${escapeHtml(file.name)}</div><div class="sub">${new Date(file.updated).toLocaleString()}</div></div><div class="actions"><input type="checkbox" onchange="toggleSelect(event,'${file.id}')" ${selectedFiles.has(file.id)?'checked':''}></div>`; fi.onclick = ()=>openFile(file.id); fi.draggable=true; fi.ondragstart=(ev)=>onDragStart(ev,file.id,'file'); fi.ondragover=(ev)=>{ev.preventDefault(); fi.classList.add('drop-target')}; fi.ondragleave=()=>fi.classList.remove('drop-target'); fi.ondrop=(ev)=>{fi.classList.remove('drop-target'); if(dragType==='file'){ reorderFile(dragId,file.id); dragId=null; render(); }}; children.appendChild(fi); }});
    cont.appendChild(el); cont.appendChild(children);
  })
}

function renderFiles(){
  const cont = document.getElementById('files'); cont.innerHTML='';
  const q = document.getElementById('search').value.toLowerCase();
  const filter = document.getElementById('filter').value;
  db.order.forEach(id=>{
    const f = db.files[id];
    if(!f) return;
    // only show files not in folder here
    if(f.folder) return;
    if(filter==='star' && !f.star) return;
    if(q){if(!(f.name.toLowerCase().includes(q) || stripTags(f.content).toLowerCase().includes(q))) return}
    const div = document.createElement('div'); div.className='file-item draggable'; div.dataset.id = f.id;
    div.innerHTML = `<div class="meta"><div class="name">${escapeHtml(f.name)}</div><div class="sub">${new Date(f.updated).toLocaleString()}</div></div>
      <div class="actions"><input type="checkbox" onchange="toggleSelect(event,'${f.id}')" ${selectedFiles.has(f.id)?'checked':''}></div>`;
    // click to open
    div.onclick = ()=>openFile(f.id);
    // drag handlers
    div.draggable = true;
    div.ondragstart = (ev)=>onDragStart(ev, f.id, 'file');
    div.ondragover = (ev)=>{ ev.preventDefault(); div.classList.add('drop-target'); };
    div.ondragleave = ()=>{ div.classList.remove('drop-target'); };
    div.ondrop = (ev)=>{ div.classList.remove('drop-target'); if(dragType==='file'){ reorderFile(dragId, f.id); dragId=null; render(); } };

    cont.appendChild(div);
  })
}

function renderMoveList(){
  const sel = document.getElementById('moveToFolder'); sel.innerHTML='';
  const opt = document.createElement('option'); opt.value='__null'; opt.textContent='ë£¨íŠ¸'; sel.appendChild(opt);
  Object.values(db.folders).forEach(f=>{const o=document.createElement('option');o.value=f.id;o.textContent=f.name;sel.appendChild(o)})
}

// --- helpers ---
function escapeHtml(s){return (s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c])}
function stripTags(html){return html.replace(/<[^>]+>/g,'')}

// --- file ops ---
function newFile(){
  const id=uid(); db.files[id]={id,name:'ë¬´ì œ',content:'',folder:null,star:false,created:Date.now(),updated:Date.now()}; db.order.unshift(id); saveDB(); render(); openFile(id);
}
function newFolder(){
  const name = prompt('í´ë” ì´ë¦„:'); if(!name) return; const id=uid('d'); db.folders[id]={id,name}; db.folderOrder = db.folderOrder || []; db.folderOrder.unshift(id); saveDB(); render();
}

function toggleFolder(id){ db.folders[id]._open = !db.folders[id]._open; render(); }
function openFolder(id){ db.folders[id]._open = !db.folders[id]._open; render(); }

function renameFolder(id){
  const name = prompt('ìƒˆ í´ë” ì´ë¦„:', db.folders[id].name); if(!name) return; db.folders[id].name=name; saveDB(); render();
}
function deleteFolder(id){
  if(!confirm('í´ë”ì™€ ê·¸ ì•ˆì˜ íŒŒì¼ë“¤ì„ ì‚­ì œí•˜ì‹œê² ì–´ìš”?')) return;
  Object.values(db.files).forEach(f=>{if(f.folder===id) delete db.files[f.id];}); delete db.folders[id]; db.folderOrder = (db.folderOrder||[]).filter(x=>x!==id); db.order = db.order.filter(x=>db.files[x]); saveDB(); render();
}

function openFile(id){
  currentFileId = id; const f = db.files[id]; document.getElementById('editor').innerHTML = f.content || '';
  document.getElementById('fileNameInput').value = f.name || '';
}

function renameCurrentFileFromInput(){
  if(!currentFileId) return; const newName = document.getElementById('fileNameInput').value.trim(); if(!newName) return alert('ì´ë¦„ì„ ë¹„ìš¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); db.files[currentFileId].name = newName; db.files[currentFileId].updated = Date.now(); saveDB(); render(); }

function saveCurrent(){
  if(!currentFileId) return alert('ë¨¼ì € íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”');
  const content = document.getElementById('editor').innerHTML;
  const f = db.files[currentFileId]; f.content = content; f.updated = Date.now(); if(!f.name || f.name==='ë¬´ì œ'){
    const t = stripTags(content).slice(0,30).trim(); if(t) f.name = t;
  }
  saveDB(); render();
}

function deleteFileById(id){
  if(!confirm('íŒŒì¼ì„ ì‚­ì œí• ê¹Œìš”?')) return; delete db.files[id]; db.order = db.order.filter(x=>x!==id); if(currentFileId===id){ currentFileId=null; document.getElementById('editor').innerHTML=''; document.getElementById('fileNameInput').value=''; } saveDB(); render();
}
function deleteCurrentFile(){ if(!currentFileId) return alert('íŒŒì¼ ì„ íƒ'); deleteFileById(currentFileId); }

function toggleSelect(ev,id){ if(ev.target.checked) selectedFiles.add(id); else selectedFiles.delete(id); }

function toggleStar(id){ db.files[id].star = !db.files[id].star; saveDB(); render(); }

function downloadTxt(id){ const f=db.files[id]; const blob=new Blob([stripTags(f.content)],{type:'text/plain;charset=utf-8'}); saveAs(blob, (f.name||'untitled')+'.txt'); }
function downloadDocx(id){ const f = db.files[id]; const html = `<html><body>${f.content||''}</body></html>`; try{ const converted = window.htmlDocx.asBlob(html); saveAs(converted, (f.name||'document') + '.docx'); }catch(e){alert('DOCX ìƒì„± ì‹¤íŒ¨: '+e.message)} }
function downloadPdf(id){ const f=db.files[id]; const { jsPDF } = window.jspdf; const doc = new jsPDF(); const text = stripTags(f.content); const lines = doc.splitTextToSize(text, 180); doc.text(lines,10,10); const blob = doc.output('blob'); saveAs(blob, (f.name||'doc') + '.pdf'); }

function downloadSelectedFormats(formats){ if(!currentFileId) return alert('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”'); formats.forEach(fmt=>{ if(fmt==='txt') downloadTxt(currentFileId); if(fmt==='docx') downloadDocx(currentFileId); if(fmt==='pdf') downloadPdf(currentFileId); }); }

// --- import ---
const fileInput = document.getElementById('fileInput'); fileInput.addEventListener('change', async e=>{
  const filesList = Array.from(e.target.files);
  for(const file of filesList){
    const name = prompt(`ë¶ˆëŸ¬ì˜¬ íŒŒì¼ì˜ ì´ë¦„ (íŒŒì¼: ${file.name})`, file.name.replace(/\.[^.]+$/,''));
    if(!name) continue;
    try{
      if(file.name.endsWith('.txt')||file.type.includes('text')){
        const txt = await file.text(); const id=uid(); db.files[id]={id,name,content:escapeHtml(txt).replace(/\n/g,'<br>'),folder:null,star:false,created:Date.now(),updated:Date.now()}; db.order.unshift(id);
      } else if(file.name.endsWith('.docx')){
        const arr = await file.arrayBuffer(); const id=uid(); db.files[id]={id,name,content:`(DOCX íŒŒì¼ â€” ì›ë³¸ì´ ì²¨ë¶€ë¨)`,raw:{type:'docx',data:arrayBufferToBase64(arr)},folder:null,star:false,created:Date.now(),updated:Date.now()}; db.order.unshift(id);
      } else if(file.name.endsWith('.pdf')){
        const arr = await file.arrayBuffer(); const id=uid(); db.files[id]={id,name,content:`(PDF íŒŒì¼ â€” ë¯¸ë¦¬ë³´ê¸° ì—†ìŒ)`,raw:{type:'pdf',data:arrayBufferToBase64(arr)},folder:null,star:false,created:Date.now(),updated:Date.now()}; db.order.unshift(id);
      } else {
        const txt = await file.text(); const id=uid(); db.files[id]={id,name,content:escapeHtml(txt).replace(/\n/g,'<br>'),folder:null,star:false,created:Date.now(),updated:Date.now()}; db.order.unshift(id);
      }
    } catch(err){console.error(err)}
  }
  saveDB(); render(); fileInput.value='';
});

function arrayBufferToBase64(buffer){ let binary=''; const bytes = new Uint8Array(buffer); const len = bytes.byteLength; for(let i=0;i<len;i++){binary+=String.fromCharCode(bytes[i]);} return btoa(binary); }

// --- merge selected ---
function mergeSelected(){ if(selectedFiles.size<2) return alert('ë‘ ê°œ ì´ìƒì˜ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”');
  const ids = Array.from(selectedFiles); let merged=''; let name='ë³‘í•©ë¬¸ì„œ'; ids.forEach(id=>{const f=db.files[id]; merged += `<h3>${escapeHtml(f.name)}</h3>` + (f.content||'') + '<hr>';});
  const id = uid(); db.files[id]={id,name: name,content:merged,folder:null,star:false,created:Date.now(),updated:Date.now()}; db.order.unshift(id); saveDB(); render(); openFile(id); selectedFiles.clear();
}

// --- delete selected ---
function deleteSelected(){ if(selectedFiles.size===0) return alert('ì„ íƒëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤'); if(!confirm('ì„ íƒëœ íŒŒì¼ì„ ì‚­ì œí• ê¹Œìš”?')) return; selectedFiles.forEach(id=>{delete db.files[id]; db.order = db.order.filter(x=>x!==id)}); saveDB(); render(); selectedFiles.clear(); }

// --- move ---
function moveSelected(){ if(selectedFiles.size===0) return alert('ì„ íƒëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤'); const to = document.getElementById('moveToFolder').value; selectedFiles.forEach(id=>{db.files[id].folder = (to==='__null'?null:to); db.files[id].updated = Date.now()}); saveDB(); render(); selectedFiles.clear(); }

// --- UI bindings ---
document.getElementById('btnNewFile').onclick = newFile;
document.getElementById('btnNewFolder').onclick = newFolder;
document.getElementById('search').addEventListener('input', render);
document.getElementById('filter').addEventListener('change', render);
document.getElementById('btnSaveExport').onclick = ()=>{ openSaveExportModal(); };
document.getElementById('btnMerge').onclick = mergeSelected;
document.getElementById('btnDeleteSelected').onclick = deleteSelected;

// actions menu
const btnActions = document.getElementById('btnActions'); btnActions.addEventListener('click', ()=>{ openActionsMenu(); });

// move
const btnMove = document.getElementById('btnMove'); const selMove = document.getElementById('moveToFolder');
btnMove && (btnMove.onclick = ()=>{ if(selMove.style.display==='none'){selMove.style.display='inline-block'; btnMove.textContent='ì´ë™(í™•ì¸)';} else {moveSelected(); selMove.style.display='none'; btnMove.textContent='ì´ë™';}})

// star
document.getElementById('btnStar')?.addEventListener('click', ()=>{ if(!currentFileId) return alert('íŒŒì¼ ì„ íƒ'); toggleStar(currentFileId); });

// merge UI quick
let mergeMode=false; document.getElementById('btnMergeUI').onclick = ()=>{mergeMode=!mergeMode; alert('ë³‘í•© UI ' + (mergeMode?'í™œì„±í™”':'ë¹„í™œì„±í™”') + '. ì¢Œì¸¡ì—ì„œ íŒŒì¼ì„ ì²´í¬í•œ ë’¤ "ì„ íƒ íŒŒì¼ ë³‘í•©" í´ë¦­')}

// autosave
const autoSaveCb = document.getElementById('autoSave'); autoSaveCb.addEventListener('change', ()=>{ if(autoSaveCb.checked) startAutoSave(); else stopAutoSave();}); let autoSaveTimer=null;
function startAutoSave(){ if(autoSaveTimer) clearInterval(autoSaveTimer); autoSaveTimer = setInterval(()=>{ if(currentFileId) saveCurrent(); }, 3000);} function stopAutoSave(){ if(autoSaveTimer) clearInterval(autoSaveTimer); autoSaveTimer=null}

// keyboard shortcuts
document.addEventListener('keydown', e=>{
  if((e.ctrlKey||e.metaKey) && e.key==='s'){ e.preventDefault(); saveCurrent(); alert('ì €ì¥ë¨'); }
  if((e.ctrlKey||e.metaKey) && e.key==='b'){ e.preventDefault(); doCmd('bold'); }
});

// editor change to update file name preview
document.getElementById('editor').addEventListener('input', ()=>{ if(currentFileId){ db.files[currentFileId].updated=Date.now(); }});

// fileName input rename
const fileNameInput = document.getElementById('fileNameInput'); fileNameInput.addEventListener('change', renameCurrentFileFromInput);

// sidebar toggle
const toggleSidebarBtn = document.getElementById('toggleSidebarBtn'); const expandHandle = document.getElementById('expandHandle');
toggleSidebarBtn.addEventListener('click', ()=>{ document.getElementById('sidebar').classList.toggle('hidden'); toggleSidebarBtn.textContent = document.getElementById('sidebar').classList.contains('hidden') ? 'â¡' : 'â¬…'; });
expandHandle.addEventListener('click', ()=>{ document.getElementById('sidebar').classList.remove('hidden'); toggleSidebarBtn.textContent='â¬…'; });

// settings modal
const btnSettings = document.getElementById('btnSettings'); btnSettings.addEventListener('click', ()=>{ openSettingsModal(); });

// helper: command
function doCmd(cmd, val=null){ document.execCommand(cmd, false, val); }

// toggle dark
let dark=false; function applyDark(d){ dark = !!d; document.documentElement.classList.toggle('dark', dark); document.body.classList.toggle('dark', dark); localStorage.setItem('wn_dark', dark? '1':'0'); }
// load saved theme
if(localStorage.getItem('wn_dark')==='1') applyDark(true);

// download whole database
function exportAll(){ const blob = new Blob([JSON.stringify(db, null, 2)],{type:'application/json'}); saveAs(blob, 'web-notes-backup.json'); }

// import backup
async function importBackupFile(file){ const txt = await file.text(); try{ db = JSON.parse(txt); saveDB(); render(); alert('ë°±ì—… ë³µì›ë¨'); }catch(e){alert('ë³µì›ì‹¤íŒ¨') } }

// utility: open first file
if(db.order.length) openFile(db.order[0]);
render();

// expose some functions for inline buttons
window.newFile=newFile; window.newFolder=newFolder; window.openFile=openFile; window.deleteFile=deleteFileById; window.toggleStar=toggleStar; window.toggleSelect=toggleSelect; window.downloadTxt=downloadTxt; window.mergeSelected=mergeSelected; window.deleteSelected=deleteSelected; window.exportDocx=downloadDocx; window.exportPdf=downloadPdf; window.saveCurrent=saveCurrent; window.render=render; window.saveDB=saveDB;

// --- UI modal implementations ---
function openModal(contentHtml){ const root = document.getElementById('modalRoot'); root.innerHTML = `<div class="modal-backdrop"> <div class="modal">${contentHtml}</div> </div>`; root.style.display='block'; root.querySelector('.modal-backdrop').addEventListener('click', (e)=>{ if(e.target.classList.contains('modal-backdrop')) closeModal(); }); }
function closeModal(){ const root = document.getElementById('modalRoot'); root.innerHTML=''; root.style.display='none'; }

function openSaveExportModal(){ if(!currentFileId) return alert('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”'); const html = `
  <h3>ë‚´ë³´ë‚´ê¸° í˜•ì‹ ì„ íƒ</h3>
  <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
    <label><input type="checkbox" id="fmt_txt" checked> .txt</label>
    <label><input type="checkbox" id="fmt_docx"> .docx</label>
    <label><input type="checkbox" id="fmt_pdf"> .pdf</label>
  </div>
  <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
    <button id="exportCancel">ì·¨ì†Œ</button>
    <button id="exportOk">ë‚´ë³´ë‚´ê¸°</button>
  </div>
`;
  openModal(html);
  document.getElementById('exportCancel').onclick = closeModal;
  document.getElementById('exportOk').onclick = ()=>{
    const fmts = [];
    if(document.getElementById('fmt_txt').checked) fmts.push('txt');
    if(document.getElementById('fmt_docx').checked) fmts.push('docx');
    if(document.getElementById('fmt_pdf').checked) fmts.push('pdf');
    if(fmts.length===0) return alert('í•˜ë‚˜ ì´ìƒ ì„ íƒí•˜ì„¸ìš”');
    saveCurrent(); downloadSelectedFormats(fmts); closeModal();
  };
}

function openActionsMenu(){ if(!currentFileId) return alert('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”'); const html = `
  <h3>ì‘ì—…</h3>
  <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
    <button id="act_delete">ì‚­ì œ</button>
    <button id="act_toggle_star">ë¶ë§ˆí¬ í† ê¸€</button>
    <div style="display:flex;gap:8px;align-items:center"><select id="act_move_list"></select><button id="act_move_confirm">ì´ë™</button></div>
  </div>
  <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
    <button id="act_close">ë‹«ê¸°</button>
  </div>
`;
  openModal(html);
  const moveList = document.getElementById('act_move_list'); moveList.innerHTML=''; const opt = document.createElement('option'); opt.value='__null'; opt.textContent='ë£¨íŠ¸'; moveList.appendChild(opt); Object.values(db.folders).forEach(f=>{ const o=document.createElement('option'); o.value=f.id; o.textContent=f.name; moveList.appendChild(o); });
  document.getElementById('act_delete').onclick = ()=>{ if(confirm('íŒŒì¼ì„ ì‚­ì œí• ê¹Œìš”?')){ deleteFileById(currentFileId); closeModal(); } };
  document.getElementById('act_toggle_star').onclick = ()=>{ toggleStar(currentFileId); closeModal(); };
  document.getElementById('act_move_confirm').onclick = ()=>{ const to = moveList.value; db.files[currentFileId].folder = (to==='__null'?null:to); db.files[currentFileId].updated = Date.now(); saveDB(); render(); closeModal(); };
  document.getElementById('act_close').onclick = closeModal;
}

function openSettingsModal(){ const html = `
  <h3>í™˜ê²½ì„¤ì •</h3>
  <div style="display:flex;flex-direction:column;gap:10px;margin-top:10px">
    <label><input type="checkbox" id="setting_dark"> ë‹¤í¬ëª¨ë“œ ì‚¬ìš©</label>
    <div>ì œì‘ì: <a href="https://github.com/2000may24th" target="_blank">2000may24th (GitHub)</a></div>
    <div style="display:flex;gap:8px;justify-content:flex-end"><button id="setting_close">ë‹«ê¸°</button></div>
  </div>
`;
  openModal(html);
  document.getElementById('setting_dark').checked = dark;
  document.getElementById('setting_dark').onchange = (e)=>{ applyDark(e.target.checked); };
  document.getElementById('setting_close').onclick = closeModal;
}

</script>
</body>
</html>
